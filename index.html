<!doctype html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1.0" />
  <title>IPUC Â· Miembros (PWA)</title>

  <!-- PWA -->
  <link rel="manifest" href="./manifest.json" />
  <meta name="theme-color" content="#0b1020" />

  <!-- Iconos -->
  <link rel="icon" sizes="192x192" href="./icono-192.png" />
  <link rel="icon" sizes="512x512" href="./icono-512.png" />

  <!-- Meta tags para iOS (Safari) -->
  <link rel="apple-touch-icon" sizes="180x180" href="./apple-icon.png">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="IPUC Miembros">

  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">

  <style>
    :root{
      --bg:#0b1020;--card:#121a33;--muted:#9aa4c0;--text:#e9ecf6;
      --accent:#4c7dff;--border:rgba(255,255,255,.08);--ok:#2dd4bf;--danger:#ff4c6a;
      color-scheme: dark;
    }
    *{box-sizing:border-box}
    body{
      margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;color:var(--text);
      background:
        radial-gradient(1200px 600px at 20% 10%, rgba(76,125,255,0.25), transparent 60%),
        radial-gradient(1000px 500px at 90% 30%, rgba(45,212,191,0.18), transparent 60%),
        var(--bg);
      overflow-x: hidden; /* âœ… evita que algo estire la pantalla */
    }

    .header{
  position:sticky;
  top:0;
  backdrop-filter:blur(12px);
  background:rgba(11,16,32,.75);
  border-bottom:1px solid var(--border);
  z-index: 20; /* âœ… antes era 5: ahora queda por encima del toolbar-sticky */
}

    .header-inner{display:flex;align-items:center;justify-content:space-between;padding:12px 20px}
    .brand{display:flex;flex-direction:column;gap:2px}
    .brand .title{font-weight:900;letter-spacing:.2px}
    .small{font-size:12px;color:var(--muted)}
    .nav{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    .btn{
      padding:10px 14px;border-radius:12px;border:1px solid var(--border);
      background:rgba(255,255,255,.06);color:var(--text);cursor:pointer;
      font-weight: 600; letter-spacing:.2px;
      transition: background .15s ease, border-color .15s ease, transform .05s ease;
    }
    .btn:hover{background:rgba(255,255,255,.10)}
    .btn:active{ transform: translateY(1px); }
    .btn.ok{
      background: rgba(255,255,255,.06);
      border: 1px solid var(--border);
      color: var(--text);
    }
    .btn.ok:hover{ background: rgba(255,255,255,.10); }
    .btn.primary{
      background: linear-gradient(180deg, #4c7dff, #3c68e0);
      border: none;
      color: #fff;
      box-shadow: 0 6px 18px rgba(76,125,255,.25);
    }
    .btn.primary:hover{
      background: linear-gradient(180deg, #5a88ff, #4c7dff);
    }
    .btn.edit{
      background: transparent;
      border: 1px solid rgba(154,164,192,.35);
      color: var(--muted);
    }
    .btn.edit:hover{
      background: rgba(255,255,255,.05);
      color: var(--text);
    }
    .btn.danger{
      background: rgba(255,76,106,.08);
      border: 1px solid rgba(255,76,106,.35);
      color: #ff8fa3;
    }
    .btn.danger:hover{
      background: rgba(255,76,106,.14);
      color: #ffd1da;
    }

    .container{max-width:1200px;margin:0 auto;padding:20px}
.card{
  background:rgba(18,26,51,.9);border:1px solid var(--border);border-radius:16px;
  padding:16px;box-shadow:0 12px 40px rgba(0,0,0,.25);
  max-width: 100%;
  overflow: visible; /* âœ… permite sticky y dropdowns */
}


    hr.sep{border:0;border-top:1px solid var(--border);margin:14px 0}
    .row{display:flex;gap:16px;flex-wrap:wrap;margin-bottom:6px;}
    .col{flex:1;min-width:220px}
    label{display:block;font-size:13px;color:var(--muted);margin-bottom:8px;}
    input,select,textarea{
      width:100%;
      padding:12px 14px;
      font-size:14px;
      background:rgba(0,0,0,.25);
      color:var(--text);
      border:1px solid var(--border);
      border-radius:14px;
      outline:none;
      pointer-events:auto;
      max-width: 100%;
    }
    input::placeholder, textarea::placeholder{ color: rgba(154,164,192,.75); }
    input[type="date"]{ color-scheme: dark; }
    input[type="file"]{ color: var(--muted); }
    input[type="file"]::-webkit-file-upload-button{
      background: rgba(255,255,255,.08);
      border: 1px solid var(--border);
      color: var(--text);
      border-radius: 10px;
      padding: 8px 10px;
      cursor: pointer;
    }
    input[type="file"]::-webkit-file-upload-button:hover{ background: rgba(255,255,255,.12); }

    textarea{min-height:180px;resize:vertical}
    .badge{display:inline-flex;gap:6px;align-items:center;padding:6px 10px;border-radius:999px;border:1px solid var(--border);background:rgba(255,255,255,.05);color:var(--muted);max-width:100%}
    .panel{background:rgba(0,0,0,.15);border:1px solid var(--border);border-radius:16px;padding:14px;max-width:100%}
    .muted{color:var(--muted)}
    .hint{font-size:12px;color:var(--muted);margin-top:6px}
    .avatar{
      width:150px;height:150px;border-radius:18px;border:1px solid var(--border);
      background: rgba(0,0,0,.35);
      display:flex;align-items:center;justify-content:center;
      overflow:hidden;
    }
    .avatar img{max-width:100%;max-height:100%;object-fit:contain;}
    /* âœ… Fotos mÃ¡s PRO */
.avatar{
  background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(0,0,0,.18));
  box-shadow: 0 12px 30px rgba(0,0,0,.25);
}

.avatar img{
  width:100%;
  height:100%;
  object-fit: cover;     /* âœ… antes contain: ahora se ve mejor */
  display:block;
}

/* Contenedores de fotos (miembro y acudiente) */
#photoFileBox, #guardianPhotoFileBox{
  display:flex;
  flex-direction:column;
  gap:10px;
}

/* Cuando estÃ¡ en solo lectura, centramos y quitamos â€œruidoâ€ visual */
.panel.view-mode #photoFileBox,
.panel.view-mode #guardianPhotoFileBox{
  align-items:center;
  text-align:center;
  background: rgba(0,0,0,.10);
}

/* En solo lectura: ocultaremos botones/inputs/hints con esta clase */
.readonly-hide{ display:none !important; }

/* Ajuste de tamaÃ±o del cuadro del acudiente para que no se vea raro */
#guardianPhotoBox{
  width:150px !important;
  height:150px !important;
  border-radius:18px !important;
}

    .filebox{border:1px dashed var(--border);border-radius:14px;padding:10px;background:rgba(255,255,255,.03);}
    .grid-2{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    @media (max-width: 980px){ .grid-2{grid-template-columns:1fr} }

    .searchbar{display:flex;gap:10px;align-items:center;flex-wrap:wrap;}
    .searchbar input{padding:10px 12px;min-width:0;}
    .search-actions{display:flex;gap:10px;align-items:center;flex-wrap:wrap;}

    .suggestions{
      position:absolute;top:calc(100% + 8px);left:0;right:0;
      border:1px solid var(--border);border-radius:14px;background:rgba(0,0,0,.92);
      display:none;z-index:9999;max-height:280px;overflow-y:auto;overflow-x:hidden;
      box-shadow:0 18px 45px rgba(0,0,0,.45);
    }
    .suggestions::-webkit-scrollbar{width:8px}
    .suggestions::-webkit-scrollbar-track{background:transparent}
    .suggestions::-webkit-scrollbar-thumb{background:rgba(255,255,255,.15);border-radius:10px}
    .suggestions::-webkit-scrollbar-thumb:hover{background:rgba(255,255,255,.25)}
    .suggestions .item{
      padding:10px 12px;cursor:pointer;display:flex;justify-content:space-between;gap:10px;
      border-top:1px solid var(--border);
    }
    .suggestions .item:first-child{border-top:none}
    .suggestions .item:hover{background:rgba(255,255,255,.06)}
    .suggestions .left{display:flex;flex-direction:column;gap:2px;min-width:0}
    .suggestions .right{color:var(--muted);font-size:12px;white-space:nowrap}

    .toast-container{
      position: fixed; top: 20px; left: 50%; transform: translateX(-50%);
      z-index: 9999; display:flex; flex-direction:column; align-items:center; pointer-events:none;
    }
    .toast{ pointer-events:auto; }
    .toast{
      background: rgba(18,26,51,.95);
      border: 1px solid var(--border);
      border-radius: 14px;
      padding: 14px 16px;
      margin-bottom: 10px;
      min-width: 260px;
      max-width: 360px;
      color: var(--text);
      box-shadow: 0 10px 30px rgba(0,0,0,.35);
      animation: toastIn .25s ease-out;
      font-size: 14px;
    }
    .toast.error{ border-left: 4px solid var(--danger); }
    .toast.success{ border-left: 4px solid var(--ok); }
    .toast.info{ border-left: 4px solid var(--accent); }
    @keyframes toastIn{ from{ opacity:0; transform: translateY(-6px);} to{ opacity:1; transform: translateY(0);} }

    .aviso-contenedor{
      position: fixed; top:0; left:0; right:0; bottom:0;
      background: rgba(0,0,0,0.5);
      display:flex; justify-content:center; align-items:center;
      z-index: 99999; opacity:0; visibility:hidden; transition: all .3s ease;
      backdrop-filter: blur(4px);
      padding: 16px; overflow:auto;
    }
    .aviso-contenedor.mostrar{ opacity:1; visibility:visible; }
    .aviso{
      background: rgba(18,26,51,.98);
      padding: 28px 32px;
      border-radius: 20px;
      max-width: 90%;
      width: 420px;
      text-align: center;
      box-shadow: 0 15px 40px rgba(0,0,0,0.3);
      transform: scale(0.9) translateY(20px);
      transition: all 0.35s cubic-bezier(0.34, 1.56, 0.64, 1);
      color: var(--text);
      border: 1px solid var(--border);
      max-height: calc(100vh - 32px);
      overflow: auto;
    }
    .aviso-contenedor.mostrar .aviso{ transform: scale(1) translateY(0); }

    .select{
      padding:10px 12px;border-radius:12px;border:1px solid var(--border);
      background:rgba(255,255,255,.06);color:var(--text);outline:none;cursor:pointer;
      max-width: 100%;
    }
    .select:hover{ background:rgba(255,255,255,.10); }
    .select option{ background:#0b1020;color:var(--text); }

    .count-badge{flex:0 0 auto;white-space:nowrap;max-width:100%}
    .count-number{display:inline-block;min-width:3ch;text-align:right}

    .auth-area{ position: relative; display:flex; align-items:center; gap:8px; }
    .avatar-btn{
      width: 36px; height: 36px; border-radius: 999px;
      border: 1px solid var(--border); background: rgba(255,255,255,.06); color: var(--text);
      display:flex; align-items:center; justify-content:center; cursor:pointer; user-select:none; font-weight:800;
    }
    .avatar-btn:hover{ background: rgba(255,255,255,.10); }
    .avatar-btn img{ width:100%; height:100%; border-radius:999px; object-fit:cover; display:block; }
    .auth-menu{
      position:absolute; top: calc(100% + 10px); right: 0; width: 280px;
      border:1px solid var(--border); border-radius:16px; background: rgba(0,0,0,.92);
      box-shadow:0 18px 45px rgba(0,0,0,.45);
      padding:12px; display:none; z-index:9999;
    }
    .auth-menu.show{ display:block; }
    .auth-menu .line{ border-top:1px solid var(--border); margin:10px 0; }
    .auth-menu .email{ font-size:13px; color: var(--text); word-break: break-all; }

    /* Layout ficha */
    .panel .row{ display:grid; grid-template-columns: repeat(3, minmax(0, 1fr)); gap:18px; }
    .panel .row[style*="align-items:flex-start"]{ display:flex; gap:12px; flex-wrap:wrap; }
    @media (max-width: 980px){ .panel .row{ grid-template-columns: repeat(1, minmax(0, 1fr)); } }

    input[disabled], textarea[disabled]{
      opacity: 1 !important;
      -webkit-text-fill-color: var(--text);
      cursor: not-allowed;
    }
    .no-interaction{ pointer-events:none !important; }
    .panel.view-mode .row[style*="align-items:flex-start"]{
      display:flex !important; flex-direction: column; align-items:center; justify-content:center; gap:14px;
    }
    .panel.view-mode .row[style*="align-items:flex-start"] > div:first-child{
      width:100%; display:flex; justify-content:center;
    }
    .panel.view-mode .row[style*="align-items:flex-start"] > .col{ width:100%; }
    .panel.view-mode .row[style*="align-items:flex-start"] > .col .row{
      display:grid; grid-template-columns: repeat(3, minmax(0, 1fr)); gap:18px;
    }
    @media (max-width: 980px){
      .panel.view-mode .row[style*="align-items:flex-start"] > .col .row{ grid-template-columns: repeat(1, minmax(0, 1fr)); }
    }

    /* âœ… Ajustes mÃ³viles para que CategorÃ­as + contador NO desborden */
    @media (max-width: 620px){
      .header-inner{padding:12px 14px}
      .container{padding:14px}
      .searchbar{flex-direction:column;align-items:stretch}
      .search-actions{width:100%}
      .search-actions .btn{flex:1}
      #categoryFilter{min-width:0 !important; width: 100% !important;}
      #memberCountBadge{width:100%; justify-content:space-between;}
    }



/* âœ… Barra sticky (categorÃ­as + contador + botones) */
:root{
  --header-offset: 72px; /* fallback; JS lo ajusta */
}

.toolbar-sticky{
  position: sticky;
  top: var(--header-offset);
  z-index: 6;

  background: rgba(18,26,51,.95);
  backdrop-filter: blur(12px);

  /* âœ… sin hacks que crean espacio vacÃ­o */
  padding-bottom: 12px;
  margin-bottom: 14px;

  border-bottom: 1px solid var(--border);
}

/* âœ… FIX mÃ³vil: el input file no debe ensanchar la pantalla */
input[type="file"]{
  width: 100% !important;
  max-width: 100% !important;
  display: block;
  overflow: hidden;
}

/* Evita que el nombre del archivo se salga (Safari/Chrome mÃ³vil) */
input[type="file"]::-webkit-file-upload-button{
  max-width: 100%;
}

/* En iOS a veces el texto del nombre del archivo se va largo */
.filebox{
  max-width: 100%;
  overflow: hidden;
}

#photoFileBox{
  max-width: 100%;
}

#photoInfo{
  max-width: 100%;
  overflow: hidden;
  text-overflow: ellipsis;
  white-space: nowrap;
}

/* Por si algÃºn contenedor flex estÃ¡ empujando */
.searchbar, .row, .col{
  min-width: 0;
}




    /* âœ… FIX mÃ³vil: bloque de foto (avatar + filebox) no debe desbordar ni quedar enorme */
@media (max-width: 620px){
  /* Esta es EXACTAMENTE la fila que tiene style="align-items:flex-start" (foto + formulario) */
  .panel .row[style*="align-items:flex-start"]{
    flex-direction: column;
    align-items: stretch;
  }

  /* El contenedor que tiene la foto (el primer div dentro de esa fila) */
  .panel .row[style*="align-items:flex-start"] > div:first-child{
    width: 100%;
    max-width: 100%;
  }

  /* El filebox y el input adentro a ancho completo */
  #photoFileBox{
    width: 100%;
    max-width: 100%;
  }

  #photoInput{
    width: 100% !important;
    max-width: 100% !important;
  }

  /* (Opcional) centrar el cuadro de la foto sin agrandar nada */
  #photoBox{
    margin: 0 auto;
  }
}

/* âœ… Loader overlay (bloquea UI mientras guarda) */
.loader-overlay{
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,.45);
  backdrop-filter: blur(3px);
  z-index: 999999;
  display: none;
  align-items: center;
  justify-content: center;
  padding: 18px;
}
.loader-overlay.show{ display: flex; }

.loader-box{
  background: rgba(18,26,51,.98);
  border: 1px solid var(--border);
  border-radius: 18px;
  padding: 16px 18px;
  width: min(420px, 92vw);
  box-shadow: 0 18px 50px rgba(0,0,0,.45);
  display:flex;
  align-items:center;
  gap: 12px;
}

.loader-spinner{
  width: 22px;
  height: 22px;
  border-radius: 999px;
  border: 3px solid rgba(255,255,255,.18);
  border-top-color: rgba(255,255,255,.85);
  animation: spin .8s linear infinite;
  flex: 0 0 auto;
}
@keyframes spin{ to{ transform: rotate(360deg); } }

.loader-text{
  display:flex;
  flex-direction:column;
  gap: 2px;
  min-width: 0;
}
.loader-title{ font-weight: 800; }
.loader-sub{ font-size: 12px; color: var(--muted); }

#avisoContenedor,
#confirmContenedor{
  z-index: 9999999 !important;
}

.guardian-center{ text-align:center; }
.guardian-center .avatar{ margin: 0 auto; }
.guardian-actions{ display:flex; gap:10px; justify-content:center; flex-wrap:wrap; }
    
  </style>
</head>

<body>
  <div id="toastContainer" class="toast-container"></div>

  <div id="avisoContenedor" class="aviso-contenedor">
    <div id="aviso" class="aviso">
      <h3 id="avisoTitulo">Aviso</h3>
      <p id="avisoMensaje"></p>
      <div style="margin-top:18px;">
        <button class="btn primary" id="avisoAceptar">Aceptar</button>
      </div>
    </div>
  </div>

  <div id="confirmContenedor" class="aviso-contenedor">
    <div id="confirmBox" class="aviso">
      <h3 id="confirmTitulo">Confirmar</h3>
      <p id="confirmMensaje"></p>
      <div style="margin-top:18px; display:flex; gap:10px; justify-content:center; flex-wrap:wrap;">
        <button class="btn" id="confirmNo">Cancelar</button>
        <button class="btn danger" id="confirmSi">Eliminar</button>
      </div>
    </div>
  </div>

  <!-- âœ… Loader global -->
<div id="loaderOverlay" class="loader-overlay" aria-hidden="true">
  <div class="loader-box" role="status" aria-live="polite">
    <div class="loader-spinner"></div>
    <div class="loader-text">
      <div class="loader-title" id="loaderTitle">Procesandoâ€¦</div>
      <div class="loader-sub" id="loaderSub">Por favor espera</div>
    </div>
  </div>
</div>

<div id="loginContenedor" class="aviso-contenedor">
  <div class="aviso">
    <h3>Iniciar sesiÃ³n</h3>
    <p class="small muted" style="margin-top:-6px;">Ingresa tu correo autorizado</p>

   <div style="text-align:left; margin-top:14px;">
  <label>Cargo / Rol (para notificaciones)</label>
  <input id="loginRole" placeholder="Ej: lÃ­der dorcas, lÃ­der jÃ³venes, caballeros..." />
  <div class="hint">Se usa para enviarte avisos personalizados por tu Ã¡rea.</div>
</div>



    <div style="text-align:left; margin-top:14px;">
      <label>Correo *</label>
      <input id="loginEmail" type="email" placeholder="correo@dominio.com" autocomplete="email" />
      <div class="hint">Se validarÃ¡ contra allowed_emails en Supabase.</div>
    </div>

    <div style="margin-top:18px; display:flex; gap:10px; justify-content:center; flex-wrap:wrap;">
      <button class="btn" id="btnLoginCancel">Cancelar</button>
      <button class="btn primary" id="btnLoginOk">Entrar</button>
    </div>
  </div>
</div>

<!-- âœ… Modal CumpleaÃ±os por Mes (PWA) -->
<div id="cumplePwaContenedor" class="aviso-contenedor">
  <div class="aviso" style="width:760px; max-width:96%; text-align:left;">
    <div style="display:flex; align-items:center; justify-content:space-between; gap:12px; flex-wrap:wrap;">
      <div style="display:flex; align-items:center; gap:10px; flex-wrap:wrap;">
        <h3 style="margin:0;">ðŸŽ‚ CumpleaÃ±os por mes</h3>

        <select id="cumplePwaMesSelect" class="select" style="min-width:180px; width:auto;">
          <option value="0">Enero</option>
          <option value="1">Febrero</option>
          <option value="2">Marzo</option>
          <option value="3">Abril</option>
          <option value="4">Mayo</option>
          <option value="5">Junio</option>
          <option value="6">Julio</option>
          <option value="7">Agosto</option>
          <option value="8">Septiembre</option>
          <option value="9">Octubre</option>
          <option value="10">Noviembre</option>
          <option value="11">Diciembre</option>
        </select>

        <span class="badge" id="cumplePwaCount">0</span>
      </div>

      <div style="display:flex; gap:10px; flex-wrap:wrap;">
        <!-- (Opcional) manda push solo a ESTE telÃ©fono -->
        <button class="btn ok" id="btnCumplePwaPushSelf">ðŸ”” Enviar a este telÃ©fono</button>

        <button class="btn" id="btnCumplePwaClose">Cerrar</button>
      </div>
    </div>

    <hr class="sep" />

    <div class="panel">
      <div class="small muted" id="cumplePwaSub">Cargandoâ€¦</div>
      <div id="cumplePwaList" style="margin-top:10px;"></div>

      <div class="hint" style="margin-top:10px;">
        * Solo muestra miembros con <b>fecha de nacimiento</b> registrada.
      </div>
    </div>
  </div>
</div>


  <div id="app"></div>

  <script type="module">
    import { supabase, SUPABASE_URL, SUPABASE_ANON_KEY, VAPID_PUBLIC_KEY, safeStorage } from "./supabase-config.js";
    if ("serviceWorker" in navigator) {
      window.addEventListener("load", async () => {
        try {
          await navigator.serviceWorker.register("./sw.js", { scope: "./" });
        } catch (e) {
          console.log("SW register error:", e);
        }
      });
    }



 

    const app = document.getElementById("app");

    // ===== UI helpers =====
    function el(html){
      const t=document.createElement("template");
      t.innerHTML=html.trim();
      return t.content.firstElementChild;
    }

function showLoader(title="Procesandoâ€¦", sub="Por favor espera"){
  const ov = document.getElementById("loaderOverlay");
  const t = document.getElementById("loaderTitle");
  const s = document.getElementById("loaderSub");
  if (!ov) return;

  if (t) t.textContent = title;
  if (s) s.textContent = sub;

  ov.classList.add("show");
  ov.setAttribute("aria-hidden", "false");
}

function hideLoader(){
  const ov = document.getElementById("loaderOverlay");
  if (!ov) return;
  ov.classList.remove("show");
  ov.setAttribute("aria-hidden", "true");
}


    
    function toast(msg, kind="info"){
      const cont = document.getElementById("toastContainer");
      const node = document.createElement("div");
      node.className = "toast " + (kind==="error"?"error":kind==="success"?"success":"info");
      node.textContent = msg;
      cont.appendChild(node);
      setTimeout(()=>{ node.remove(); }, 3500);
    }

function publicUrlFromPath(bucket, path){
  const p = String(path || "").trim();
  if (!p) return "";
  const { data } = supabase.storage.from(bucket).getPublicUrl(p);
  return data?.publicUrl || "";
}

function normalizePhoneToE164CO(raw){
  // Convierte telÃ©fonos colombianos comunes a +57XXXXXXXXXX
  let p = String(raw || "").trim();

  // quitar espacios, guiones, parÃ©ntesis
  p = p.replace(/[^\d+]/g, "");

  if (!p) return "";

  // si ya viene con +, asumimos E.164
  if (p.startsWith("+")) return p;

  // quitar ceros iniciales raros
  p = p.replace(/^0+/, "");

  // si tiene 10 dÃ­gitos (celular CO tÃ­pico), agregar +57
  if (/^\d{10}$/.test(p)) return `+57${p}`;

  // si viene 57 + 10 dÃ­gitos
  if (/^57\d{10}$/.test(p)) return `+${p}`;

  // si viene 9 o menos, lo dejamos como estÃ¡ (no adivinamos)
  return p;
}

function openWhatsApp(phoneRaw, message){
  const phone = normalizePhoneToE164CO(phoneRaw);
  if (!phone || phone.length < 8){
    toast("Este miembro no tiene telÃ©fono vÃ¡lido.", "info");
    return;
  }

  const text = encodeURIComponent(String(message || ""));
  const num = phone.replace("+", ""); // wa.me requiere sin +
  const url = `https://wa.me/${num}?text=${text}`;

  // abre WhatsApp / WhatsApp Web
  window.open(url, "_blank", "noopener,noreferrer");
}




// ===================== CUMPLEAÃ‘OS POR MES (PWA) =====================
const MESES_TXT = [
  "Enero","Febrero","Marzo","Abril","Mayo","Junio",
  "Julio","Agosto","Septiembre","Octubre","Noviembre","Diciembre"
];

function openCumplePwaModal(){
  const cont = document.getElementById("cumplePwaContenedor");
  const sel  = document.getElementById("cumplePwaMesSelect");
  if (!cont || !sel) return;

  // mes actual por defecto
  sel.value = String(new Date().getMonth());
  cont.classList.add("mostrar");

  // cargar lista
  cargarCumplePwaMes(Number(sel.value));
}

function closeCumplePwaModal(){
  document.getElementById("cumplePwaContenedor")?.classList.remove("mostrar");
}

function fmtDiaMes(yyyyMMdd){
  const s = String(yyyyMMdd || "");
  // esperado "YYYY-MM-DD"
  if (s.length < 10) return "";
  const mm = s.slice(5,7);
  const dd = s.slice(8,10);
  return `${dd}/${mm}`;
}

async function cargarCumplePwaMes(mesIndex){
  const sub = document.getElementById("cumplePwaSub");
  const list = document.getElementById("cumplePwaList");
  const count = document.getElementById("cumplePwaCount");
  if (!sub || !list || !count) return;

  list.innerHTML = "";
  sub.textContent = "Verificando sesiÃ³nâ€¦";

  const ok = await requireAuth();
  if (!ok){
    sub.textContent = "Login requerido para ver cumpleaÃ±os.";
    count.textContent = "0";
    return;
  }

  sub.textContent = `Cargando cumpleaÃ±os de ${MESES_TXT[mesIndex]}â€¦`;

  // ðŸ”¥ Ahora tambiÃ©n trae datos de padre y madre
  const { data, error } = await supabase
    .from("members")
    .select(`
      id,
      first_names,
      last_names,
      birth_date,
      father_name,
      father_birth_date,
      mother_name,
      mother_birth_date,
      city,
      phone
    `)
    .limit(5000);

  if (error){
    sub.textContent = "Error cargando cumpleaÃ±os.";
    toast("âŒ CumpleaÃ±os: " + error.message, "error");
    count.textContent = "0";
    return;
  }

  const items = [];

  (data || []).forEach(m => {

    const nombreMiembro = `${m.first_names || ""} ${m.last_names || ""}`.trim();

    // ===== MIEMBRO =====
    if (m.birth_date){
      const d = String(m.birth_date);
      if (d.length >= 10){
        const mm = Number(d.slice(5,7)) - 1;
        if (mm === Number(mesIndex)){
          items.push({
            tipo: "Miembro",
            nombre: nombreMiembro,
            birth_date: m.birth_date,
            city: m.city,
            phone: m.phone,
            id: m.id
          });
        }
      }
    }

    // ===== PADRE =====
    if (m.father_birth_date){
      const d = String(m.father_birth_date);
      if (d.length >= 10){
        const mm = Number(d.slice(5,7)) - 1;
        if (mm === Number(mesIndex)){
          items.push({
            tipo: "Padre",
            nombre: m.father_name || "Padre",
            birth_date: m.father_birth_date,
            city: m.city,
            phone: m.phone,
            id: m.id + "_father"
          });
        }
      }
    }

    // ===== MADRE =====
    if (m.mother_birth_date){
      const d = String(m.mother_birth_date);
      if (d.length >= 10){
        const mm = Number(d.slice(5,7)) - 1;
        if (mm === Number(mesIndex)){
          items.push({
            tipo: "Madre",
            nombre: m.mother_name || "Madre",
            birth_date: m.mother_birth_date,
            city: m.city,
            phone: m.phone,
            id: m.id + "_mother"
          });
        }
      }
    }

  });

  // ordenar por dÃ­a
  items.sort((a,b)=>{
    const da = Number(String(a.birth_date).slice(8,10));
    const db = Number(String(b.birth_date).slice(8,10));
    return da - db;
  });

  count.textContent = String(items.length);
  sub.textContent = items.length
    ? `Hay ${items.length} cumpleaÃ±os en ${MESES_TXT[mesIndex]}.`
    : `No hay cumpleaÃ±os en ${MESES_TXT[mesIndex]}.`;

  if (items.length === 0){
    list.innerHTML = `<div class="small muted">ðŸŽ‰ No hay cumpleaÃ±os registrados para este mes.</div>`;
    return;
  }

  const wrap = document.createElement("div");
  wrap.style.display = "grid";
  wrap.style.gap = "10px";

  for (const m of items){

    const dia = fmtDiaMes(m.birth_date);
    const ciudad = (m.city || "").trim();
    const tel = (m.phone || "").trim();

    const row = document.createElement("div");
    row.className = "panel";
    row.style.padding = "12px";

    const waId = `btnWaCumple_${m.id}`;

    row.innerHTML = `
      <div style="display:flex; align-items:center; justify-content:space-between; gap:10px; flex-wrap:wrap;">
        <div style="min-width:0;">
          <div style="font-weight:800;">
            ${m.nombre || "(Sin nombre)"} 
            <span class="badge">${m.tipo}</span>
          </div>
          <div class="small muted">
            ${dia ? "ðŸŽ‚ " + dia : ""}${ciudad ? " Â· " + ciudad : ""}${tel ? " Â· ðŸ“ž " + tel : ""}
          </div>
        </div>

        <div style="display:flex; align-items:center; gap:10px;">
          <button class="btn ok" id="${waId}" style="padding:8px 10px;">ðŸ’¬ WhatsApp</button>
          <span class="badge">${dia || "--/--"}</span>
        </div>
      </div>
    `;

    setTimeout(() => {
      const btn = row.querySelector(`#${waId}`);
      if (!btn) return;

      btn.addEventListener("click", (e) => {
        e.preventDefault();
        e.stopPropagation();

        const msg = `Hola ${m.nombre || ""} ðŸ˜Š Â¡Feliz cumpleaÃ±os! ðŸŽ‚ðŸŽ‰\nDios te bendiga.`;
        openWhatsApp(m.phone || "", msg);
      });

      if (!tel){
        btn.disabled = true;
        btn.title = "No hay telÃ©fono disponible";
        btn.style.opacity = "0.6";
      }
    }, 0);

    wrap.appendChild(row);
  }

  list.appendChild(wrap);
}


    function urlBase64ToUint8Array(base64String) {
  const padding = "=".repeat((4 - (base64String.length % 4)) % 4);
  const base64 = (base64String + padding).replace(/-/g, "+").replace(/_/g, "/");
  const rawData = atob(base64);
  const outputArray = new Uint8Array(rawData.length);
  for (let i = 0; i < rawData.length; ++i) outputArray[i] = rawData.charCodeAt(i);
  return outputArray;
}

async function enablePushAndRegister() {
  const ok = await requireAuth();
  if (!ok) return;

  const perm = await Notification.requestPermission();
  if (perm !== "granted") {
    toast("Debes permitir notificaciones.", "info");
    return;
  }

  const reg = await navigator.serviceWorker.ready;

  const subscription = await reg.pushManager.subscribe({
    userVisibleOnly: true,
    applicationServerKey: urlBase64ToUint8Array(VAPID_PUBLIC_KEY),
  });

const res = await fetch(`${SUPABASE_URL}/functions/v1/register-push`, {
  method: "POST",
  headers: {
    "Content-Type": "application/json",
    "apikey": SUPABASE_ANON_KEY
  },
body: JSON.stringify({
  subscription,
  email: state.auth.email,
  notify_role: String(state.auth.notify_role || "").trim(), // âœ… rol del usuario receptor
}),


});


  const data = await res.json().catch(() => ({}));
  console.log("register-push:", res.status, data);

  if (res.ok) toast("âœ… Notificaciones activadas.", "success");
  else toast("âŒ Error registrando push: " + (data?.error || data?.message || res.status), "error");
}


async function sendBirthdayPushNow(){
  try{
    const ok = await requireAuth();
    if (!ok) return;

    const reg = await navigator.serviceWorker.ready;
    const subscription = await reg.pushManager.getSubscription();
    if (!subscription){
      toast("Primero activa ðŸ”” Notificaciones para este dispositivo.", "info");
      return;
    }

    toast("ðŸ“¨ Enviando solo a ESTE telÃ©fonoâ€¦", "info");

 const res = await fetch(`${SUPABASE_URL}/functions/v1/send-birthday-push-self`, {
  method: "POST",
  headers: {
    "Content-Type": "application/json",
    "apikey": SUPABASE_ANON_KEY,
    "Authorization": `Bearer ${SUPABASE_ANON_KEY}`,
  },
  body: JSON.stringify({
    email: state.auth.email,
    subscription,
  }),
});


    const data = await res.json().catch(()=> ({}));
    console.log("send-birthday-push-self:", res.status, data);

    if (res.ok){
      toast(`âœ… Enviado a este dispositivo. Cumples: ${data.birthdays || 0}`, "success");
    } else {
      toast("âŒ Error: " + (data?.error || data?.message || res.status), "error");
    }
  } catch(e){
    console.error(e);
    toast("âŒ Error enviando: " + (e?.message || e), "error");
  }
}




    function mostrarAviso(mensaje, tipo="info", titulo=null){
      const cont = document.getElementById("avisoContenedor");
      const tituloEl = document.getElementById("avisoTitulo");
      const mensajeEl = document.getElementById("avisoMensaje");
      tituloEl.textContent = titulo || (tipo==="success"?"Â¡Ã‰xito!":tipo==="error"?"Error":tipo==="alerta"?"AtenciÃ³n":"Aviso");
      mensajeEl.textContent = mensaje;
      cont.classList.add("mostrar");
    }
    function cerrarAviso(){ document.getElementById("avisoContenedor").classList.remove("mostrar"); }
    document.getElementById("avisoAceptar").addEventListener("click", cerrarAviso);

    function confirmarHTML(mensaje, titulo="Confirmar"){
      return new Promise((resolve)=>{
        const cont = document.getElementById("confirmContenedor");
        const tEl = document.getElementById("confirmTitulo");
        const mEl = document.getElementById("confirmMensaje");
        const btnNo = document.getElementById("confirmNo");
        const btnSi = document.getElementById("confirmSi");

        tEl.textContent = titulo || "Confirmar";
        mEl.textContent = mensaje || "";

        const cerrar = (valor) => {
          cont.classList.remove("mostrar");
          btnNo.onclick = null;
          btnSi.onclick = null;
          cont.onclick = null;
          resolve(valor);
        };

        btnNo.onclick = () => cerrar(false);
        btnSi.onclick = () => cerrar(true);
        cont.onclick = (e) => { if (e.target === cont) cerrar(false); };

        cont.classList.add("mostrar");
      });
    }

    function normalizeEmail(email){ return String(email||"").trim().toLowerCase(); }

const AUTH_EMAIL_KEY = "ipuc-miembros-email";
const AUTH_ROLE_KEY  = "ipuc-miembros-notify-role";
    

function openLoginModal(){
  const cont = document.getElementById("loginContenedor");
  const input = document.getElementById("loginEmail");
  const roleInput = document.getElementById("loginRole"); // âœ… nuevo
  const btnOk = document.getElementById("btnLoginOk");
  const btnCancel = document.getElementById("btnLoginCancel");

  return new Promise((resolve) => {
    const close = (value) => {
      cont.classList.remove("mostrar");
      btnOk.onclick = null;
      btnCancel.onclick = null;
      cont.onclick = null;
      resolve(value);
    };

    input.value = "";
    if (roleInput) roleInput.value = ""; // âœ… limpia rol
    cont.classList.add("mostrar");
    setTimeout(()=> input.focus(), 50);

    btnCancel.onclick = () => close(null);

    // âœ… ahora devuelve {email, notify_role}
    btnOk.onclick = () => close({
      email: normalizeEmail(input.value),
      notify_role: String(roleInput?.value || "").trim()
    });

    cont.onclick = (e) => { if (e.target === cont) close(null); };

    input.onkeydown = (e) => {
      if (e.key === "Enter") btnOk.click();
      if (e.key === "Escape") btnCancel.click();
    };

    // âœ… Enter tambiÃ©n desde rol
    if (roleInput){
      roleInput.onkeydown = (e) => {
        if (e.key === "Enter") btnOk.click();
        if (e.key === "Escape") btnCancel.click();
      };
    }
  });
}


async function loginWithEmailModal(){
  const login = await openLoginModal();
  if (!login?.email) return;

  const email = normalizeEmail(login.email);
  const notify_role = String(login.notify_role || "").trim();

  try{
    const allowed = await isEmailAllowed(email);
    if (!allowed){
      mostrarAviso(`El correo no tiene permiso para usar esta app:\n\n${email}`, "alerta", "Cuenta no autorizada");
      return;
    }

    // âœ… guarda email + rol
    safeStorage.setItem(AUTH_EMAIL_KEY, email);
    safeStorage.setItem(AUTH_ROLE_KEY, notify_role);

    state.auth.authed = true;
    state.auth.ready = true;
    state.auth.email = email;
    state.auth.photoUrl = "";
    state.auth.notify_role = notify_role; // âœ… nuevo

    toast("âœ… SesiÃ³n iniciada.", "success");
    render();

  } catch(e){
    state.auth.ready = true;
    mostrarAviso("No se pudo verificar el permiso del correo.\n\n" + (e?.message || e), "error", "Permisos");
  }
}


async function logoutLocal(){
  safeStorage.removeItem(AUTH_EMAIL_KEY);
  safeStorage.removeItem(AUTH_ROLE_KEY); // âœ… nuevo

  state.auth.authed = false;
  state.auth.ready = true;
  state.auth.email = "";
  state.auth.photoUrl = "";
  state.auth.notify_role = ""; // âœ… nuevo

  toast("âœ… SesiÃ³n cerrada.", "success");
  render();
}




async function bootstrapLocalAuth(){
  const saved = normalizeEmail(safeStorage.getItem(AUTH_EMAIL_KEY));
  const savedRole = String(safeStorage.getItem(AUTH_ROLE_KEY) || "").trim(); // âœ… nuevo

  if (!saved){
    state.auth.authed = false;
    state.auth.ready = true;
    state.auth.email = "";
    state.auth.photoUrl = "";
    state.auth.notify_role = ""; // âœ… nuevo
    render();
    return;
  }

  try{
    const allowed = await isEmailAllowed(saved);
    if (!allowed){
      safeStorage.removeItem(AUTH_EMAIL_KEY);
      safeStorage.removeItem(AUTH_ROLE_KEY);

      state.auth.authed = false;
      state.auth.ready = true;
      state.auth.email = "";
      state.auth.photoUrl = "";
      state.auth.notify_role = "";
      render();

      mostrarAviso(`El correo ya no estÃ¡ autorizado:\n\n${saved}`, "alerta", "Cuenta no autorizada");
      return;
    }

    state.auth.authed = true;
    state.auth.ready = true;
    state.auth.email = saved;
    state.auth.photoUrl = "";
    state.auth.notify_role = savedRole; // âœ… nuevo
    render();

  } catch(e){
    state.auth.ready = true;
    state.auth.authed = false;
    state.auth.email = "";
    state.auth.photoUrl = "";
    state.auth.notify_role = "";
    render();

    mostrarAviso("No se pudo validar el correo guardado.\n\n" + (e?.message || e), "error", "Permisos");
  }
}






    async function isEmailAllowed(email){
      const e = normalizeEmail(email);
      if (!e) return false;
      const { data, error } = await supabase.from("allowed_emails").select("email");
      if (error) throw new Error("allowed_emails: " + error.message);
      const list = (data||[]).map(r=>normalizeEmail(r.email)).filter(Boolean);
      return list.includes(e);
    }

async function requireAuth({ silent = false } = {}){
  try{
    if (state.auth.authed && state.auth.ready) return true;

    const saved = normalizeEmail(safeStorage.getItem(AUTH_EMAIL_KEY));
    const savedRole = String(safeStorage.getItem(AUTH_ROLE_KEY) || "").trim(); // âœ… nuevo

    if (!saved){
      state.auth.authed = false;
      state.auth.ready = true;
      state.auth.email = "";
      state.auth.photoUrl = "";
      state.auth.notify_role = ""; // âœ… nuevo
      render();

      if (!silent){
        mostrarAviso("Debes iniciar sesiÃ³n para usar esta funciÃ³n.", "alerta", "Login requerido");
      }
      return false;
    }

    const allowed = await isEmailAllowed(saved);
    if (!allowed){
      safeStorage.removeItem(AUTH_EMAIL_KEY);
      safeStorage.removeItem(AUTH_ROLE_KEY);

      state.auth.authed = false;
      state.auth.ready = true;
      state.auth.email = "";
      state.auth.photoUrl = "";
      state.auth.notify_role = "";
      render();

      if (!silent){
        mostrarAviso(`El correo ya no estÃ¡ autorizado:\n\n${saved}`, "alerta", "Cuenta no autorizada");
      }
      return false;
    }

    state.auth.authed = true;
    state.auth.ready = true;
    state.auth.email = saved;
    state.auth.photoUrl = "";
    state.auth.notify_role = savedRole; // âœ… nuevo
    return true;

  } catch(e){
    state.auth.authed = false;
    state.auth.ready = true;
    state.auth.notify_role = "";
    render();

    if (!silent){
      mostrarAviso("No se pudo verificar la sesiÃ³n.\n\n" + (e?.message || e), "error", "SesiÃ³n");
    }
    return false;
  }
}




    // ===== Storage helpers =====
    function safeName(name){ return String(name||"").replace(/[^\w.\-]+/g,"_").slice(0,120); }

    async function uploadFile(bucket, file, prefix){
      if (!file) return { path:null, url:null };
      const ext = (String(file.name||"").split(".").pop() || "bin").toLowerCase();
      const fileName = `${prefix}_${Date.now()}_${safeName(file.name)}`;
      const storagePath = `${prefix}/${fileName}.${ext}`;

      const { error: upErr } = await supabase.storage.from(bucket).upload(storagePath, file, { upsert:true });
      if (upErr) throw new Error("Upload error: " + upErr.message);

      const { data } = supabase.storage.from(bucket).getPublicUrl(storagePath);
      return { path: storagePath, url: data?.publicUrl || null };
    }


    
function looksLikeAuthError(err){
  const msg = String(err?.message || err || "").toLowerCase();
  return (
    msg.includes("jwt") ||
    msg.includes("token") ||
    msg.includes("expired") ||
    msg.includes("invalid") ||
    msg.includes("not authenticated") ||
    msg.includes("permission denied") ||
    msg.includes("row level security") ||
    msg.includes("rls") ||
    msg.includes("401") ||
    msg.includes("403")
  );
}

async function withAuthRetry(fn){
  try{
    return await fn();
  } catch(e){
    if (!looksLikeAuthError(e)) throw e;

    // âœ… intenta recuperar sesiÃ³n silenciosamente y reintenta una vez
    const ok = await requireAuth({ silent: true });
    if (!ok) throw e;

    return await fn();
  }
}



    
    // ===== Members API (misma lÃ³gica que tu preload) =====
    async function searchMembers(query){
      const q = String(query||"").trim();
      if (!q) return [];
      const like = `%${q}%`;
      const { data, error } = await supabase
        .from("members")
        .select("*")
        .or(`identification.ilike.${like},first_names.ilike.${like},last_names.ilike.${like}`)
        .order("created_at", { ascending:false })
        .limit(20);
      if (error) throw new Error(error.message);
      return data || [];
    }

    async function countMembers(category){
      const cat = String(category||"todo").toLowerCase();
      let q = supabase.from("members").select("id", { count:"exact", head:true });

      switch (cat) {
        case "todo": break;
        case "damas": q = q.eq("gender", "Femenino"); break;
        case "caballeros": q = q.eq("gender", "Masculino"); break;
        case "jovenes": q = q.gte("age", 13).lte("age", 35); break;
        case "adolescentes": q = q.gte("age", 12).lte("age", 17); break;
        case "senoritas": q = q.eq("gender", "Femenino").gte("age", 12).lte("age", 18); break;
        case "ninos": q = q.gte("age", 0).lte("age", 11); break;
        case "simpatizantes": q = q.eq("is_sympathizer", true); break;
        default: break;
      }
      const { count, error } = await q;
      if (error) throw new Error(error.message);
      return count ?? 0;
    }

    async function saveMember(member, photoFile){
      const prefix = (member.identification || "unknown").trim() || "unknown";
      let photo = { path:null, url:null };

      if (photoFile) photo = await uploadFile("member-photos", photoFile, prefix);
            let guardianPhoto = { path:null, url:null };
      const guardianFile = state.memberDraft?.guardian_photo_file || null;
      if (guardianFile) guardianPhoto = await uploadFile("member-photos", guardianFile, `guardian_${prefix}`);

      const payload = {
        first_names: member.first_names,
        last_names: member.last_names,
        identification: member.identification,
        age: member.age ?? null,
        gender: member.gender || null,
        church_role: member.church_role || null,
        address: member.address || null,
        city: member.city || null,
        phone: member.phone || null,
        email: member.email || null,
        father_phone: member.father_phone || null,
        mother_phone: member.mother_phone || null,
        father_birth_date: member.father_birth_date || null,
        mother_birth_date: member.mother_birth_date || null,
        guardian_photo_path: guardianPhoto.path,
        guardian_photo_url: guardianPhoto.url,
        birth_date: member.birth_date || null,
        father_name: member.father_name || null,
        mother_name: member.mother_name || null,
        congregation_name: member.congregation_name || null,
        conversion_time: member.conversion_time || null,
        baptism_date: member.baptism_date || null,
        holy_spirit_date: member.holy_spirit_date || null,
        event_place: member.event_place || null,
        officiant_pastor: member.officiant_pastor || null,
        membership_date: member.membership_date || null,
        membership_time: member.membership_time || null,
        origin_place: member.origin_place || null,
        less_than_6_months: !!member.less_than_6_months,
        is_sympathizer: !!member.is_sympathizer,
        observations: member.observations || null,
        photo_path: photo.path,
        photo_url: photo.url
        // âœ… Documento de identidad removido
      };

      const { data, error } = await supabase.from("members").insert(payload).select("*").single();
      if (error) throw new Error(error.message);
      return data;
    }

    async function updateMember(id, member, photoFile){
      if (!id) throw new Error("ID requerido para actualizar");
      const prefix = (member.identification || "unknown").trim() || "unknown";

      let photo = { path: member.photo_path || null, url: member.photo_url || null };
      if (photoFile) photo = await uploadFile("member-photos", photoFile, prefix);

            let guardianPhoto = { path: member.guardian_photo_path || null, url: member.guardian_photo_url || null };
      const guardianFile = state.memberDraft?.guardian_photo_file || null;
      if (guardianFile) guardianPhoto = await uploadFile("member-photos", guardianFile, `guardian_${prefix}`);

      const payload = {
        first_names: member.first_names,
        last_names: member.last_names,
        identification: member.identification,
        age: member.age ?? null,
        gender: member.gender || null,
        church_role: member.church_role || null,
        address: member.address || null,
        city: member.city || null,
        phone: member.phone || null,
        email: member.email || null,
        father_phone: member.father_phone || null,
        mother_phone: member.mother_phone || null,
        father_birth_date: member.father_birth_date || null,
        mother_birth_date: member.mother_birth_date || null,
        guardian_photo_path: guardianPhoto.path,
        guardian_photo_url: guardianPhoto.url,
        birth_date: member.birth_date || null,
        father_name: member.father_name || null,
        mother_name: member.mother_name || null,
        congregation_name: member.congregation_name || null,
        conversion_time: member.conversion_time || null,
        baptism_date: member.baptism_date || null,
        holy_spirit_date: member.holy_spirit_date || null,
        event_place: member.event_place || null,
        officiant_pastor: member.officiant_pastor || null,
        membership_date: member.membership_date || null,
        membership_time: member.membership_time || null,
        origin_place: member.origin_place || null,
        less_than_6_months: !!member.less_than_6_months,
        is_sympathizer: !!member.is_sympathizer,
        observations: member.observations || null,
        photo_path: photo.path,
        photo_url: photo.url
        // âœ… Documento de identidad removido
      };

      const { data, error } = await supabase.from("members").update(payload).eq("id", id).select("*").single();
      if (error) throw new Error(error.message);
      return data;
    }

    async function deleteMember(id){
      if (!id) throw new Error("ID requerido para eliminar");

      const { data: row, error: fetchErr } = await supabase
        .from("members")
        .select("id, photo_path")
        .eq("id", id)
        .maybeSingle();
      if (fetchErr) throw new Error("Error leyendo registro: " + fetchErr.message);
      if (!row) throw new Error("No existe el registro (o RLS lo bloquea).");

      if (row.photo_path){
        const { error: e1 } = await supabase.storage.from("member-photos").remove([row.photo_path]);
        if (e1) throw new Error("No se pudo borrar foto: " + e1.message);
      }

      const { data, error } = await supabase.from("members").delete().eq("id", id).select("*");
      if (error) throw new Error(error.message);
      if (!data || data.length === 0) throw new Error("No se eliminÃ³ ningÃºn registro (posible RLS/policy DELETE).");
      return data[0];
    }

    // ===== App state =====
    const state = {
      route: "miembros",
      results: [],
      selectedId: null,
      memberDraft: null,
      viewMode: "edit",
      category: "todo",
auth: {
  authed: false,
  ready: false,
  email: "",
  photoUrl: "",
  notify_role: "",     // âœ… nuevo
  allowedEmail: "",
  allowedOk: false
}


    };

    function cloneMemberSafe(obj){
      try { if (typeof structuredClone === "function") return structuredClone(obj); } catch {}
      return Object.assign({}, obj);
    }

    function blankMember(){
 return {
  first_names: "", last_names: "", identification: "",
  address: "", city: "", birth_date: "",
  phone: "",
    email: "",
  father_phone: "",
  mother_phone: "",
  father_birth_date: "",
  mother_birth_date: "",
  guardian_photo_file: null,
  guardian_photo_preview_url: "",
  guardian_photo_path: "",
  guardian_photo_url: "",
  father_name: "", mother_name: "", congregation_name: "",
  conversion_time: "", baptism_date: "", holy_spirit_date: "",
  event_place: "", officiant_pastor: "",
  membership_date: "", membership_time: "",
  origin_place: "",
  less_than_6_months: false,
  is_sympathizer: false,
  observations: "",
  photo_file: null,
  photo_preview_url: "",
  id_document_file: null,
  gender: "",
  age: null,
  church_role: ""
};

    }


    // ===== INVITES (link pÃºblico) =====

// tabla recomendada en Supabase: invite_links
// columnas: token_hash (text), created_at (timestamp), expires_at (timestamp), used_at (timestamp null)
async function createInviteToken(){
  // token aleatorio seguro
  const raw = crypto.getRandomValues(new Uint8Array(16));
  const token = Array.from(raw).map(b=>b.toString(16).padStart(2,"0")).join("");

  // hash simple (mejor guardar hash en DB, no el token plano)
  const enc = new TextEncoder().encode(token);
  const digest = await crypto.subtle.digest("SHA-256", enc);
  const hash = Array.from(new Uint8Array(digest)).map(b=>b.toString(16).padStart(2,"0")).join("");

  // expira en 7 dÃ­as (ajÃºstalo)
  const expires = new Date(Date.now() + 7*24*60*60*1000).toISOString();

  // registra el hash del token en supabase
  const { error } = await supabase
    .from("invite_links")
    .insert({ token_hash: hash, expires_at: expires });

  if (error) throw new Error(error.message);

  return token; // este es el que va en el link
}

function getInviteTokenFromUrl(){
  const p = new URLSearchParams(location.search);
  return (p.get("invite") || "").trim();
}

function clearInviteFromUrl(){
  const url = new URL(location.href);
  url.searchParams.delete("invite");
  history.replaceState({}, "", url.toString());
}


    // ===== Header =====
    function renderHeader(){
      const node = el(`
        <div class="header">
          <div class="header-inner">
            <div class="brand">
              <div class="title">PENTAGRAMA Â· Padres 2026</div>
              <div class="small">MÃ³dulo Miembros</div>
            </div>

            <div class="nav">
              <span class="badge">Solo Miembros</span>

<button class="btn ok" id="btnCumplePwaOpen">ðŸŽ‚</button>


              <div class="auth-area" id="authArea">
                 <button class="btn ok" id="btnEnablePush" style="display:none;">ðŸ””</button>
                <button class="btn" id="btnLogin" style="display:none;">Iniciar sesiÃ³n</button>

                <div id="avatarWrap" style="display:none;">
                  <div class="avatar-btn" id="btnAvatar" title="Cuenta"></div>
                  <div class="auth-menu" id="authMenu">
                    <div style="display:flex; gap:10px; align-items:center;">
                      <div class="avatar-btn" id="menuAvatar" style="flex:0 0 auto;"></div>
                      <div style="min-width:0;">
                        <div class="muted">SesiÃ³n iniciada</div>
                        <div class="email" id="menuEmail"></div>
                      </div>
                    </div>
                    <div class="line"></div>
                    <button class="btn danger" id="btnLogout" style="width:100%;">Cerrar sesiÃ³n</button>
                  </div>
                </div>
              </div>
            </div>

          </div>
        </div>
      `);

      const btnLogin = node.querySelector("#btnLogin");
      const avatarWrap = node.querySelector("#avatarWrap");
      const btnAvatar = node.querySelector("#btnAvatar");
      const menu = node.querySelector("#authMenu");
      const menuEmail = node.querySelector("#menuEmail");
      const menuAvatar = node.querySelector("#menuAvatar");
      const btnLogout = node.querySelector("#btnLogout");

      function initialFromEmail(email){
        const e = String(email || "").trim();
        if (!e) return "G";
        return e[0].toUpperCase();
      }
function paintAuthFast(){
  // âœ… protege por si btnEnablePush no existe (evita que se caiga la app)
  const hasPushBtn = !!btnEnablePush;

  if (state.auth?.authed){
    if (hasPushBtn) btnEnablePush.style.display = ""; // âœ… mostrar si estÃ¡ logueado
    btnLogin.style.display = "none";
    avatarWrap.style.display = "";

    const letter = initialFromEmail(state.auth.email);
    btnAvatar.innerHTML = "";
    menuAvatar.innerHTML = "";

    if (state.auth.photoUrl){
      const img = document.createElement("img");
      img.src = state.auth.photoUrl;
      img.alt = "Cuenta";
      btnAvatar.appendChild(img);

      const img2 = document.createElement("img");
      img2.src = state.auth.photoUrl;
      img2.alt = "Cuenta";
      menuAvatar.appendChild(img2);
    } else {
      btnAvatar.textContent = letter;
      menuAvatar.textContent = letter;
    }

    menuEmail.textContent = state.auth.email || "";
  } else {
    if (hasPushBtn) btnEnablePush.style.display = "none"; // âœ… ocultar si NO estÃ¡ logueado
    menu.classList.remove("show");
    avatarWrap.style.display = "none";
    btnLogin.style.display = "";
  }
}


// âœ… abrir modal cumpleaÃ±os
const btnCumplePwaOpen = node.querySelector("#btnCumplePwaOpen");
btnCumplePwaOpen?.addEventListener("click", () => {
  try { openCumplePwaModal(); } catch (e) { console.error(e); }
});


      btnAvatar?.addEventListener("click", (e)=>{
        e.stopPropagation();
        menu.classList.toggle("show");
      });
      window.addEventListener("click", ()=> menu.classList.remove("show"));

  btnLogin?.addEventListener("click", async ()=>{
  await loginWithEmailModal();

  
});
const btnEnablePush = node.querySelector("#btnEnablePush");

btnEnablePush?.addEventListener("click", async () => {
  try { await enablePushAndRegister(); }
  catch (e) { console.error(e); toast("Error activando push: " + (e?.message || e), "error"); }
});


btnLogout?.addEventListener("click", async ()=>{
  await logoutLocal();
});


      paintAuthFast();
      return node;
    }

    // ===== Miembros view =====
function viewMiembros(){
  if (!state.memberDraft) state.memberDraft = blankMember();

 const node = el(`
    <div class="container">
      <div class="card">

  <div class="toolbar-sticky">
<div class="row" style="align-items:center;justify-content:space-between;">
<div style="min-width:0;">
  <h3 style="margin:0;">MÃ³dulo: Miembros</h3>

  <div style="display:flex; align-items:center; gap:12px; flex-wrap:wrap; max-width:100%;">
    <div class="small">BÃºsqueda y registro de miembros</div>

    <div style="display:flex; align-items:center; gap:10px; flex-wrap:wrap; width:100%; max-width:560px;">
      <span class="small">CategorÃ­as</span>

      <select id="categoryFilter" class="select" style="min-width:240px; width:auto; flex:1 1 240px;">
        <option value="todo">Todo</option>
        <option value="damas">Damas Dorcas</option>
        <option value="caballeros">Caballeros</option>
        <option value="jovenes">JÃ³venes</option>
        <option value="adolescentes">Adolescentes</option>
        <option value="senoritas">SeÃ±oritas</option>
        <option value="ninos">NiÃ±os</option>
        <option value="simpatizantes">Simpatizantes</option>
      </select>

      <span class="badge count-badge" id="memberCountBadge" style="flex:1 1 180px;">
        Miembros: <b id="memberCount" class="count-number">0</b>
      </span>
    </div>
  </div>
</div>

<div style="display:flex;gap:10px;flex-wrap:wrap;">
  <button class="btn ok" id="btnNew">+ Nuevo</button>
  <button class="btn edit" id="btnEdit">Editar</button>
  <button class="btn danger" id="btnDelete">Eliminar</button>

  <button class="btn" id="btnSendBirthday" style="display:none;">ðŸŽ‚</button>

  <button class="btn" id="btnShareForm">ðŸ”— Compartir formulario</button>

  <button class="btn primary" id="btnSave">Guardar</button>
</div>

</div>

<hr class="sep" />
</div>


        <div class="panel" style="margin-bottom:14px; position:relative;">
          <label>Buscador (Nombre/Apellido o IdentificaciÃ³n)</label>

          <div class="searchbar">
            <input id="searchBox" placeholder="Ej: Juan PÃ©rez o 123456789" />
            <div class="search-actions">
              <button class="btn primary" id="btnSearch">Buscar</button>
              <button class="btn" id="btnClearSearch">Limpiar</button>
            </div>
          </div>

          <div class="suggestions" id="suggestions"></div>
        </div>

        <div class="row">
          <div class="col">
            <div class="panel">
              <div style="display:flex;align-items:center;justify-content:space-between;gap:12px;flex-wrap:wrap;">
                <div style="display:flex;align-items:center;gap:12px;flex-wrap:wrap;">
                  <div class="small">Ficha del miembro</div>
                  <div style="display:flex;align-items:center;gap:8px;">
                    <span class="small">Folio #</span>
                    <input id="folio_number" disabled style="width:140px; padding:8px 10px;" />
                  </div>
                </div>
                <div class="badge" id="statusBadge">Sin guardar</div>
              </div>

              <hr class="sep" />

              <div class="row" style="align-items:flex-start;">
                <div style="flex:0 0 auto;">
                  <div class="avatar" id="photoBox">
                    <div class="small">Sin foto</div>
                  </div>

                  <div style="margin-top:10px;" class="filebox" id="photoFileBox">
                    <label>Foto del miembro (JPG/PNG/WebP)</label>

                    <div style="display:flex; gap:10px; flex-wrap:wrap;">
                      <button class="btn ok" type="button" id="btnTakePhoto">ðŸ“· Tomar foto</button>
                      <button class="btn" type="button" id="btnPickPhoto">ðŸ–¼ï¸ Elegir archivo</button>
                    </div>

                    <!-- âœ… CÃ¡mara (Android): abre cÃ¡mara -->
                    <input id="photoInputCamera" type="file" accept="image/*" capture="environment" style="display:none;" />

                    <!-- âœ… Archivo (galerÃ­a/archivos): el que ya tenÃ­as -->
                    <input id="photoInput" type="file" accept="image/*" style="display:none;" />

                    <div class="hint" id="photoInfo">Se mostrarÃ¡ aquÃ­ como vista previa.</div>
                  </div>


                </div>

                <div class="col">
                  <div class="row">
                    <div class="col">
                      <label>Nombres *</label>
                      <input id="first_names"  />
                    </div>
                    <div class="col">
                      <label>Apellidos *</label>
                      <input id="last_names" />
                    </div>
                    <div class="col">
                      <label>IdentificaciÃ³n *</label>
                      <input id="identification" inputmode="numeric" pattern="[0-9]*" autocomplete="off" />
                    </div>
                  </div>



                  <div class="row" style="margin-top:10px;">
                    <div class="col">
                      <label>DirecciÃ³n</label>
                      <input id="address" />
                    </div>
                    <div class="col">
                      <label>Ciudad</label>
                      <input id="city" />
                    </div>
                    <div class="col">
                      <label>Fecha de nacimiento</label>
                      <input id="birth_date" type="date" />
                    </div>
                  </div>

                  <div class="row" style="margin-top:10px;">
                    <div class="col">
                      <label>TelÃ©fono</label>
                      <input id="phone" placeholder="Ej: 3001234567" inputmode="tel" />
                    </div>
                  </div>

                  <!-- âœ… NUEVO: Correo electrÃ³nico -->
                  <div class="row" style="margin-top:10px;">
                    <div class="col">
                      <label>Correo electrÃ³nico</label>
                      <input id="email" type="email" placeholder="correo@dominio.com" autocomplete="email" />
                    </div>
                  </div>

                  <div class="row" style="margin-top:10px;">
                    <div class="col">
                      <label>Edad *</label>
                      <input id="age" type="number" min="0" />
                    </div>

                    <div class="col">
                      <label>GÃ©nero *</label>
                      <select id="gender" class="select">
                        <option value="">-- Seleccionar --</option>
                        <option value="Masculino">Masculino</option>
                        <option value="Femenino">Femenino</option>
                      </select>
                    </div>

                    <div class="col">
                      <label>Cargo en la iglesia</label>
                      <input id="church_role" />
                    </div>
                  </div>

<!-- âœ… Foto del acudiente (centrada, antes de Nombre del padre) -->
<div style="margin-top:10px;">
  <label class="small muted" style="display:block; margin-bottom:8px; text-align:center;">
    Foto del acudiente (papÃ¡/mamÃ¡)
  </label>

  <div style="display:flex; justify-content:center;">
    <div class="avatar" id="guardianPhotoBox" style="width:150px;height:150px;">
      <div class="small">Sin foto</div>
    </div>
  </div>

  <div class="hint" id="guardianPhotoInfo" style="text-align:center;">
    Se mostrarÃ¡ aquÃ­ como vista previa.
  </div>

  <div class="filebox" id="guardianPhotoFileBox" style="margin-top:10px;">
    <div style="display:flex; gap:10px; justify-content:center; flex-wrap:wrap;">
      <button class="btn ok" type="button" id="btnTakeGuardianPhoto">ðŸ“· Tomar foto</button>
      <button class="btn" type="button" id="btnPickGuardianPhoto">ðŸ–¼ï¸ Elegir archivo</button>
    </div>

    <input id="guardianPhotoInputCamera" type="file" accept="image/*" capture="environment" style="display:none;" />
    <input id="guardianPhotoInput" type="file" accept="image/*" style="display:none;" />
  </div>
</div>

                  <div class="row" style="margin-top:10px;">
                    <div class="col">
                      <label>Nombre del padre</label>
                      <input id="father_name" />
                    </div>
                    <div class="col">
                      <label>Nombre de la madre</label>
                      <input id="mother_name" />
                    </div>
                    <div class="col">
                      <label>Nombre de la congregaciÃ³n</label>
                      <input id="congregation_name"/>
                    </div>
                  </div>

                  <!-- âœ… NUEVO: Celulares y cumpleaÃ±os de papÃ¡s -->
                  <div class="row" style="margin-top:10px;">
                    <div class="col">
                      <label>Celular del padre</label>
                      <input id="father_phone" placeholder="Ej: 3001234567" inputmode="tel" />
                    </div>
                    <div class="col">
                      <label>Celular de la madre</label>
                      <input id="mother_phone" placeholder="Ej: 3001234567" inputmode="tel" />
                    </div>
                    <div class="col">
                      <label>CumpleaÃ±os del padre</label>
                      <input id="father_birth_date" type="date" />
                    </div>
                  </div>

                  <div class="row" style="margin-top:10px;">
                    <div class="col">
                      <label>CumpleaÃ±os de la madre</label>
                      <input id="mother_birth_date" type="date" />
                    </div>
                  </div>

                </div>
              </div>

              <hr class="sep" />

              <div class="row">
                <div class="col">
                  <label>Tiempo de conversiÃ³n</label>
                  <input id="conversion_time" placeholder="Ej: 2 aÃ±os / 6 meses" />
                </div>
                <div class="col">
                  <label>Lugar bautismo/acto</label>
                  <input id="event_place"/>
                </div>
              </div>

              <div class="row" style="margin-top:10px;">
                <div class="col">
                  <label>Fecha del bautismo</label>
                  <input id="baptism_date" type="date" />
                </div>
                <div class="col">
                  <label>Fecha recepciÃ³n EspÃ­ritu Santo</label>
                  <input id="holy_spirit_date" type="date" />
                </div>
                <div class="col">
                  <label>Pastor oficiante</label>
                  <input id="officiant_pastor" />
                </div>
              </div>

              <div class="row" style="margin-top:10px;">
                <div class="col">
                  <label>Fecha membresÃ­a en la congregaciÃ³n</label>
                  <input id="membership_date" type="date" />
                </div>
                <div class="col">
                  <label>Tiempo de membresÃ­a</label>
                  <input id="membership_time" placeholder="Ej: 1 aÃ±o / 4 meses" />
                </div>
                <div class="col">
                  <label>Lugar de procedencia</label>
                  <input id="origin_place" />
                </div>
              </div>

              <div class="row" style="margin-top:10px;align-items:center;">
                <div class="col">
                  <label>Â¿Menos de 6 meses en la congregaciÃ³n?</label>
                  <input id="less_than_6_months" type="checkbox" />
                  <div class="hint">Activa si el miembro lleva menos de 6 meses.</div>
                </div>

                <div class="col">
                  <label>Simpatizante</label>
                  <input id="is_sympathizer" type="checkbox" />
                  <div class="hint">Activa si la persona es simpatizante.</div>
                </div>

                <div class="col">
                  <!-- âœ… Se eliminÃ³ todo el bloque del documento de identidad -->
                  <div class="hint muted"> </div>
                </div>
              </div>

              <div style="margin-top:10px;">
                <label>Observaciones</label>
                <textarea id="observations" placeholder="Notas adicionales..."></textarea>
              </div>

            </div>
          </div>
        </div>

      </div>
    </div>
  `);

  const $ = (id) => {
    const clean = String(id).startsWith("#") ? String(id).slice(1) : String(id);
    return node.querySelector("#" + clean);
  };

  // âœ… IdentificaciÃ³n: solo nÃºmeros (NO afecta nada mÃ¡s)
  const idInput = $("#identification");
  if (idInput){
    const onlyDigits = () => {
      const v = idInput.value || "";
      const cleaned = v.replace(/\D+/g, "");
      if (v !== cleaned) idInput.value = cleaned;
    };
    idInput.addEventListener("input", onlyDigits);
    idInput.addEventListener("paste", () => setTimeout(onlyDigits, 0));
  }

  // keep category
  const catSel = $("#categoryFilter");
  if (catSel) catSel.value = state.category || "todo";

  function setFormReadonly(isReadonly){
    const panel = $("#statusBadge")?.closest(".panel");
    if (panel) panel.classList.toggle("view-mode", isReadonly);

    const textIds = [
      "first_names","last_names","identification","address","city","phone",
      "father_name","mother_name","congregation_name",
      "conversion_time","event_place","officiant_pastor",
      "membership_time","origin_place","observations",
      "age","church_role"
    ];
    const dateIds = ["birth_date","baptism_date","holy_spirit_date","membership_date"];

    textIds.forEach(id=>{
      const e = $(id); if (!e) return;
      e.readOnly = isReadonly;
      e.disabled = false;
    });
    dateIds.forEach(id=>{
      const e = $(id); if (!e) return;
      e.disabled = isReadonly;
      e.classList.toggle("no-interaction", isReadonly);
    });

    const chk = $("#less_than_6_months"); if (chk) chk.disabled = isReadonly;
    const sym = $("#is_sympathizer"); if (sym) sym.disabled = isReadonly;
    const genderSel = $("#gender"); if (genderSel) genderSel.disabled = isReadonly;

    const photoBox = $("#photoFileBox");
    if (photoBox) photoBox.style.display = isReadonly ? "none" : "";

 // âœ… Acudiente: en solo lectura ocultar SOLO controles (pero dejar visible la foto)
// âœ… Acudiente: en solo lectura ocultar controles, pero dejar visible la foto (guardianPhotoBox)
const gFileBox = $("#guardianPhotoFileBox");
if (gFileBox) gFileBox.classList.toggle("readonly-hide", isReadonly);

[
  "btnTakeGuardianPhoto",
  "btnPickGuardianPhoto",
  "guardianPhotoInputCamera",
  "guardianPhotoInput",
  "guardianPhotoInfo" // opcional: oculta el hint en solo lectura
].forEach((id)=>{
  const elx = $(id);
  if (!elx) return;
  elx.classList.toggle("readonly-hide", isReadonly);
});

    if ($("#photoInput")) $("#photoInput").disabled = isReadonly;

    node.querySelector("#btnSave").style.display = isReadonly ? "none" : "";
    $("#statusBadge").textContent = isReadonly ? "Solo lectura" : "Sin guardar";
  }

  function syncActionButtons(){
    const isViewing = state.viewMode === "view";
    const hasSelected = !!state.selectedId;
    node.querySelector("#btnEdit").style.display = (isViewing && hasSelected) ? "" : "none";
    node.querySelector("#btnDelete").style.display = (isViewing && hasSelected) ? "" : "none";
    node.querySelector("#btnSave").style.display = (state.viewMode === "edit") ? "" : "none";
  }

  function renderPhoto(url){
    const box = $("#photoBox");
    box.innerHTML = "";
    if (!url){
      box.appendChild(el(`<div class="small">Sin foto</div>`));
      return;
    }
    const img = document.createElement("img");
    img.src = url;
    img.alt = "Foto miembro";
    box.appendChild(img);
  }

function renderGuardianPhoto(url){
  const box = $("#guardianPhotoBox");
  if (!box) return;

  box.innerHTML = "";
  if (!url){
    box.appendChild(el(`<div class="small">Sin foto</div>`));
    return;
  }

  const img = document.createElement("img");
  img.src = url;
  img.alt = "Foto acudiente";
  box.appendChild(img);
}

  function fillForm(m){
    $("#first_names").value = m.first_names || "";
    $("#last_names").value = m.last_names || "";
    $("#identification").value = m.identification || "";
    $("#address").value = m.address || "";
    $("#city").value = m.city || "";
    $("#phone").value = m.phone || "";
    $("#email").value = m.email || "";
    $("#father_phone").value = m.father_phone || "";
    $("#mother_phone").value = m.mother_phone || "";
    $("#father_birth_date").value = m.father_birth_date || "";
    $("#mother_birth_date").value = m.mother_birth_date || "";
    $("#birth_date").value = m.birth_date || "";
    $("#father_name").value = m.father_name || "";
    $("#mother_name").value = m.mother_name || "";
    $("#congregation_name").value = m.congregation_name || "";
    $("#folio_number").value = m.folio_number || "";
    $("#conversion_time").value = m.conversion_time || "";
    $("#baptism_date").value = m.baptism_date || "";
    $("#holy_spirit_date").value = m.holy_spirit_date || "";
    $("#event_place").value = m.event_place || "";
    $("#officiant_pastor").value = m.officiant_pastor || "";
    $("#membership_date").value = m.membership_date || "";
    $("#membership_time").value = m.membership_time || "";
    $("#origin_place").value = m.origin_place || "";
    $("#less_than_6_months").checked = !!m.less_than_6_months;
    $("#is_sympathizer").checked = !!m.is_sympathizer;
    $("#observations").value = m.observations || "";
    $("#age").value = (m.age ?? "") === null ? "" : (m.age ?? "");
    $("#church_role").value = m.church_role || "";
    $("#gender").value = m.gender || "";

   const memberPhotoUrl =
  m.photo_preview_url ||
  m.photo_url ||
  publicUrlFromPath("member-photos", m.photo_path) ||
  "";

const guardianPhotoUrl =
  m.guardian_photo_preview_url ||
  m.guardian_photo_url ||
  publicUrlFromPath("member-photos", m.guardian_photo_path) ||
  "";

renderPhoto(memberPhotoUrl);
renderGuardianPhoto(guardianPhotoUrl);
  }

  function readForm(){
    const m = state.memberDraft;
    m.first_names = $("#first_names").value.trim();
    m.last_names = $("#last_names").value.trim();
    m.identification = $("#identification").value.trim();
    m.address = $("#address").value.trim();
    m.city = $("#city").value.trim();
    m.phone = ($("#phone")?.value || "").trim();
    m.email = ($("#email")?.value || "").trim();
    m.father_phone = ($("#father_phone")?.value || "").trim();
    m.mother_phone = ($("#mother_phone")?.value || "").trim();
    m.father_birth_date = $("#father_birth_date")?.value || "";
    m.mother_birth_date = $("#mother_birth_date")?.value || "";
    m.birth_date = $("#birth_date").value || "";
    m.father_name = $("#father_name").value.trim();
    m.mother_name = $("#mother_name").value.trim();
    m.congregation_name = $("#congregation_name").value.trim();
    m.folio_number = ($("#folio_number").value || "").trim();
    m.conversion_time = $("#conversion_time").value.trim();
    m.baptism_date = $("#baptism_date").value || "";
    m.holy_spirit_date = $("#holy_spirit_date").value || "";
    m.event_place = $("#event_place").value.trim();
    m.officiant_pastor = $("#officiant_pastor").value.trim();
    m.membership_date = $("#membership_date").value || "";
    m.membership_time = $("#membership_time").value.trim();
    m.origin_place = $("#origin_place").value.trim();
    m.less_than_6_months = $("#less_than_6_months").checked;
    m.is_sympathizer = $("#is_sympathizer").checked;
    m.observations = $("#observations").value.trim();

    const ageRaw = ($("#age").value || "").trim();
    m.age = ageRaw === "" ? null : Number(ageRaw);

    m.church_role = $("#church_role").value.trim();
    m.gender = $("#gender").value || "";

    return m;
  }

  async function updateMemberCount(){
    const badge = $("#memberCount");
    if (!badge) return;
    try{
      const total = await countMembers(getCategoriaActual());
      badge.textContent = String(total ?? 0);
    } catch(e){
      badge.textContent = "--";
      console.log("countMembers error:", e);
    }
  }

  function getCategoriaActual(){
    const v = ($("#categoryFilter")?.value || state.category || "todo");
    return String(v).toLowerCase();
  }

  // Suggestions
  $("#suggestions")?.addEventListener("mousedown", (e)=>e.preventDefault());
  $("#suggestions")?.addEventListener("pointerdown", (e)=>e.preventDefault());

  function renderSuggestions(items){
    const box = $("#suggestions");
    if (!box) return;
    if (!items || items.length === 0){
      box.style.display = "none";
      box.innerHTML = "";
      return;
    }
    box.style.display = "block";
    box.innerHTML = "";

    items.forEach((m)=>{
      const item = el(`
        <div class="item">
          <div class="left">
            <div style="font-weight:700;">${(m.first_names||"")} ${(m.last_names||"")}</div>
            <div class="small">Doc: ${(m.identification||"")} Â· Ciudad: ${(m.city||"")}</div>
          </div>
          <div class="right">Seleccionar</div>
        </div>
      `);

      const onPick = (ev) => {
        ev.preventDefault();
        ev.stopPropagation();

        state.category = getCategoriaActual();

     state.memberDraft = cloneMemberSafe(m);

// âœ… Foto miembro: si falta URL, la construye con el PATH
state.memberDraft.photo_preview_url =
  m.photo_url ||
  publicUrlFromPath("member-photos", m.photo_path) ||
  "";

// âœ… Foto acudiente: si falta URL, la construye con el PATH
state.memberDraft.guardian_photo_preview_url =
  m.guardian_photo_url ||
  publicUrlFromPath("member-photos", m.guardian_photo_path) ||
  "";

state.selectedId = m.id || null;
state.viewMode = "view";

        renderSuggestions([]);
        render();
      };

      item.addEventListener("pointerdown", onPick);
      item.addEventListener("mousedown", onPick);

      box.appendChild(item);
    });
  }

  function debounce(fn, wait=350){
    let t=null;
    return (...args)=>{
      clearTimeout(t);
      t=setTimeout(()=>fn(...args), wait);
    };
  }

  const autoSearch = debounce(async ()=>{
    try{
      const q = ($("#searchBox").value || "").trim();
      if (!q || q.length < 2){
        renderSuggestions([]);
        return;
      }
      const items = await withAuthRetry(() => searchMembers(q));

      renderSuggestions(items);
    } catch(e){
    console.log("autoSearch error:", e);
if (looksLikeAuthError(e)){
  $("#statusBadge").textContent = "Verificando sesiÃ³n...";
  handleAppResume(); // intenta recuperar y re-habilitar
}

    }
  }, 350);

  // File inputs
// File inputs (Archivo + CÃ¡mara)
function handlePickedPhoto(file){
  state.memberDraft.photo_file = file;

  if (!file){
    state.memberDraft.photo_preview_url = "";
    renderPhoto("");
    $("#photoInfo").textContent = "Se mostrarÃ¡ aquÃ­ como vista previa.";
    return;
  }
  const url = URL.createObjectURL(file);
  state.memberDraft.photo_preview_url = url;
  renderPhoto(url);
  $("#photoInfo").textContent = `${file.name} Â· vista previa lista`;
  $("#statusBadge").textContent = "Cambios sin guardar";
}

// âœ… Archivo (galerÃ­a/archivos)
$("#photoInput").addEventListener("change", ()=>{
  const file = $("#photoInput").files?.[0] || null;
  handlePickedPhoto(file);
});

// âœ… CÃ¡mara (Android)
$("#photoInputCamera").addEventListener("change", ()=>{
  const file = $("#photoInputCamera").files?.[0] || null;
  handlePickedPhoto(file);
});

// âœ… Botones para abrir el selector correcto
$("#btnPickPhoto").addEventListener("click", ()=> $("#photoInput").click());
$("#btnTakePhoto").addEventListener("click", ()=> $("#photoInputCamera").click());


// âœ… Foto del acudiente (Archivo + CÃ¡mara)
function handlePickedGuardianPhoto(file){
  state.memberDraft.guardian_photo_file = file;

  if (!file){
    state.memberDraft.guardian_photo_preview_url = "";
    renderGuardianPhoto("");
    $("#guardianPhotoInfo").textContent = "Se mostrarÃ¡ aquÃ­ como vista previa.";
    return;
  }

  const url = URL.createObjectURL(file);
  state.memberDraft.guardian_photo_preview_url = url;
  renderGuardianPhoto(url);

  $("#guardianPhotoInfo").textContent = `${file.name} Â· vista previa lista`;
  $("#statusBadge").textContent = "Cambios sin guardar";
}

$("#guardianPhotoInput")?.addEventListener("change", ()=>{
  const file = $("#guardianPhotoInput").files?.[0] || null;
  handlePickedGuardianPhoto(file);
});

$("#guardianPhotoInputCamera")?.addEventListener("change", ()=>{
  const file = $("#guardianPhotoInputCamera").files?.[0] || null;
  handlePickedGuardianPhoto(file);
});

$("#btnPickGuardianPhoto")?.addEventListener("click", ()=> $("#guardianPhotoInput")?.click());
$("#btnTakeGuardianPhoto")?.addEventListener("click", ()=> $("#guardianPhotoInputCamera")?.click());

  [
    "first_names","last_names","identification","address","city","phone","birth_date",
    "father_name","mother_name","congregation_name","conversion_time",
    "baptism_date","holy_spirit_date","event_place","officiant_pastor",
    "membership_date","membership_time","origin_place","less_than_6_months","is_sympathizer","observations",
    "age","gender","church_role"
  ].forEach(id=>{
    const e = $(id);
    if (!e) return;
    const markDirty = ()=> ($("#statusBadge").textContent = "Cambios sin guardar");
    e.addEventListener("input", markDirty);
    e.addEventListener("change", markDirty);
  });

  // Buttons

$("#btnShareForm").addEventListener("click", async ()=>{
  // (MantÃ©n la misma regla que tus acciones: pedir auth local)
  const okAuth = await requireAuth();
  if (!okAuth) return;

  try{
    const token = await createInviteToken(); // crea el token (y lo registra en supabase)
    const link = `${location.origin}${location.pathname}?invite=${encodeURIComponent(token)}`;

    // Share API (mÃ³vil)
    if (navigator.share){
      await navigator.share({
        title: "Formulario de registro",
        text: "Abre este link y llena el formulario:",
        url: link
      });
    } else {
      // fallback: copiar
      await navigator.clipboard.writeText(link);
      toast("ðŸ”— Link copiado al portapapeles.", "success");
    }
  } catch(e){
    console.error(e);
    toast("âŒ No se pudo generar el link: " + (e?.message || e), "error");
  }
});


  $("#btnNew").addEventListener("click", ()=>{
    state.memberDraft = blankMember();
    state.selectedId = null;
    state.viewMode = "edit";
    render();
  });

$("#btnSendBirthday")?.addEventListener("click", async ()=>{
  await sendBirthdayPushNow();
});



$("#btnEdit").addEventListener("click", async ()=>{
  const okAuth = await requireAuth();
  if (!okAuth){
    $("#statusBadge").textContent = "Login requerido";
    return;
  }

  if (!state.selectedId){
    toast("âš ï¸ Selecciona un miembro primero.", "info");
    return;
  }
  state.viewMode = "edit";
  render();
});


  $("#btnDelete").addEventListener("click", async ()=>{
    try{
          const okAuth = await requireAuth();
          if (!okAuth){
            $("#statusBadge").textContent = "Login requerido";
            return;
          }

      
      if (!state.selectedId){
        toast("âš ï¸ Selecciona un miembro primero.", "info");
        return;
      }

      const nombre = `${state.memberDraft?.first_names || ""} ${state.memberDraft?.last_names || ""}`.trim();
      const ok = await confirmarHTML(
        `Â¿Seguro que deseas eliminar a "${nombre || "este miembro"}"?\n\nEsta acciÃ³n no se puede deshacer.`,
        "Eliminar miembro"
      );
      if (!ok) return;

      $("#statusBadge").textContent = "Eliminando...";
      await deleteMember(state.selectedId);

      toast("âœ… Eliminado correctamente.", "success");

      state.memberDraft = blankMember();
      state.selectedId = null;
      state.viewMode = "edit";
      $("#statusBadge").textContent = "Sin guardar";

      const sb = $("#searchBox");
      if (sb) sb.value = "";
      renderSuggestions([]);
      updateMemberCount();

      render();
    } catch(e){
      $("#statusBadge").textContent = "Error";
      mostrarAviso("âŒ Error eliminando: " + (e?.message || e), "error", "Eliminar");
    }
  });

$("#btnSave").addEventListener("click", async ()=>{
  showLoader("Guardandoâ€¦", "No cierres la app mientras se guarda");
  try{


        const okAuth = await requireAuth();
        if (!okAuth){
          // deja el badge coherente
          $("#statusBadge").textContent = "Login requerido";
          return;
        }


    
    const m = readForm();

    if (!m.first_names || !m.last_names || !m.identification){
      toast("Nombres, apellidos e identificaciÃ³n son obligatorios.", "info");
      return;
    }

    const ageNum = Number(m.age);
    if (m.age === null || !Number.isFinite(ageNum) || ageNum < 0){
      toast("La edad es obligatoria y debe ser un nÃºmero vÃ¡lido (>= 0).", "info");
      return;
    }

    if (!m.gender){
      toast("El gÃ©nero es obligatorio. Selecciona Masculino o Femenino.", "info");
      return;
    }

    const photoFile = state.memberDraft.photo_file || null;

    $("#statusBadge").textContent = "Guardando...";

    if (state.selectedId){
      await updateMember(state.selectedId, m, photoFile);
      toast("âœ… Cambios guardados correctamente.", "success");
    } else {
      await saveMember(m, photoFile);
      toast("âœ… Guardado correctamente.", "success");
    }

    $("#statusBadge").textContent = "Guardado";

    setTimeout(()=>{
      state.memberDraft = blankMember();
      state.selectedId = null;
      state.viewMode = "edit";

      const sb = $("#searchBox");
      if (sb) sb.value = "";
      renderSuggestions([]);
      updateMemberCount();

      render();
    }, 600);

  } catch(err){
    $("#statusBadge").textContent = "Error";
    const raw = String(err?.message || err || "").toLowerCase();
    const esDuplicado =
      raw.includes("duplicate key") ||
      raw.includes("unique constraint") ||
      raw.includes("violates unique") ||
      raw.includes("23505") ||
      raw.includes("already exists") ||
      raw.includes("ya existe");

    if (esDuplicado){
      mostrarAviso("âš ï¸ Ese documento de identificaciÃ³n ya estÃ¡ registrado. Revisa la bÃºsqueda.", "alerta", "Documento duplicado");
    } else {
      mostrarAviso("âŒ Error guardando: " + (err?.message || err), "error", "Guardar");
    }
  } finally {
    hideLoader();
  }
});


  $("#btnSearch").addEventListener("click", async ()=>{
    try{
      const q = ($("#searchBox").value || "").trim();
     const items = await withAuthRetry(() => searchMembers(q));

      renderSuggestions(items);
    } catch(e){
      mostrarAviso("âŒ Error buscando: " + (e?.message || e), "error", "Buscar");
    }
  });

  $("#searchBox").addEventListener("input", ()=> autoSearch());

  $("#categoryFilter")?.addEventListener("change", ()=>{
    state.category = $("#categoryFilter").value;
    updateMemberCount();
    const q = ($("#searchBox")?.value || "").trim();
    if (!q){ renderSuggestions([]); return; }
    autoSearch();
  });

  $("#searchBox").addEventListener("keydown", (e)=>{
    if (e.key === "Enter") $("#btnSearch").click();
    if (e.key === "Escape"){
      renderSuggestions([]);
      e.target.blur();
    }
  });

  $("#searchBox").addEventListener("blur", ()=>{
    setTimeout(()=> renderSuggestions([]), 150);
  });

  $("#btnClearSearch").addEventListener("click", ()=>{
    const sb = $("#searchBox");
    sb.value = "";
    renderSuggestions([]);
    sb.focus();
  });

  fillForm(state.memberDraft);
  setFormReadonly(state.viewMode === "view");
  syncActionButtons();
  updateMemberCount();

  // Gate actions by auth
 const enabled = !!state.auth.authed && !!state.auth.ready;

  $("#btnSave").disabled = !enabled;
  $("#btnDelete").disabled = !enabled;
  $("#btnEdit").disabled = !enabled;
  if (!state.auth.ready) $("#statusBadge").textContent = "Verificando sesiÃ³n...";
else if (!enabled) $("#statusBadge").textContent = "Login requerido";


  // focus
  $("#searchBox")?.focus();

  return node;
}

function viewInviteForm(inviteToken){
  // Draft local SOLO para el formulario pÃºblico
  const draft = blankMember();

  const node = el(`
    <div class="container">
      <div class="card">

        <div style="display:flex;align-items:center;justify-content:space-between;gap:10px;flex-wrap:wrap;">
          <div>
            <div style="font-weight:900;font-size:18px;">Formulario de registro</div>
            <div class="small muted">Llena el formulario y presiona Enviar.</div>
          </div>
        </div>

        <hr class="sep" />

        <!-- âœ… MISMO FORMULARIO QUE LA APP -->
        <div class="panel">
          <div style="display:flex;align-items:center;justify-content:space-between;gap:12px;flex-wrap:wrap;">
            <div class="small">Ficha del miembro</div>
            <div class="badge" id="statusBadgePublic">Formulario pÃºblico</div>
          </div>

          <hr class="sep" />

          <div class="row" style="align-items:flex-start;">
            <div style="flex:0 0 auto;">
              <div class="avatar" id="photoBox">
                <div class="small">Sin foto</div>
              </div>

              <div style="margin-top:10px;" class="filebox" id="photoFileBox">
                <label>Foto del miembro (JPG/PNG/WebP)</label>

                <div style="display:flex; gap:10px; flex-wrap:wrap;">
                  <button class="btn ok" type="button" id="btnTakePhoto">ðŸ“· Tomar foto</button>
                  <button class="btn" type="button" id="btnPickPhoto">ðŸ–¼ï¸ Elegir archivo</button>
                </div>

                <input id="photoInputCamera" type="file" accept="image/*" capture="environment" style="display:none;" />
                <input id="photoInput" type="file" accept="image/*" style="display:none;" />

                <div class="hint" id="photoInfo">Se mostrarÃ¡ aquÃ­ como vista previa.</div>
              </div>
              <!-- âœ… NUEVO: Foto del acudiente (papÃ¡/mamÃ¡) -->
<div style="margin-top:10px;" class="filebox" id="guardianPhotoFileBox">
  <label>Foto del acudiente (papÃ¡/mamÃ¡)</label>

  <div style="display:flex; gap:10px; flex-wrap:wrap;">
    <button class="btn ok" type="button" id="btnTakeGuardianPhoto">ðŸ“· Tomar foto</button>
    <button class="btn" type="button" id="btnPickGuardianPhoto">ðŸ–¼ï¸ Elegir archivo</button>
  </div>

  <input id="guardianPhotoInputCamera" type="file" accept="image/*" capture="environment" style="display:none;" />
  <input id="guardianPhotoInput" type="file" accept="image/*" style="display:none;" />
  <div class="avatar" id="guardianPhotoBox" style="width:120px;height:120px;margin-top:10px;">
  <div class="small">Sin foto</div>
</div>

  <div class="hint" id="guardianPhotoInfo">Se mostrarÃ¡ aquÃ­ como vista previa.</div>
</div>
            </div>

            <div class="col">
              <div class="row">
                <div class="col">
                  <label>Nombres *</label>
                  <input id="first_names" />
                </div>
                <div class="col">
                  <label>Apellidos *</label>
                  <input id="last_names" />
                </div>
                <div class="col">
                  <label>IdentificaciÃ³n *</label>
                  <input id="identification" inputmode="numeric" pattern="[0-9]*" autocomplete="off" />
                </div>
              </div>

              <div class="row" style="margin-top:10px;">
                <div class="col">
                  <label>DirecciÃ³n</label>
                  <input id="address" />
                </div>
                <div class="col">
                  <label>Ciudad</label>
                  <input id="city" />
                </div>
                <div class="col">
                  <label>Fecha de nacimiento</label>
                  <input id="birth_date" type="date" />
                </div>
              </div>

              <div class="row" style="margin-top:10px;">
                <div class="col">
                  <label>TelÃ©fono</label>
                  <input id="phone" placeholder="Ej: 3001234567" inputmode="tel" />
                </div>
              </div>

              <!-- âœ… NUEVO: Correo electrÃ³nico -->
<div class="row" style="margin-top:10px;">
  <div class="col">
    <label>Correo electrÃ³nico</label>
    <input id="email" type="email" placeholder="correo@dominio.com" autocomplete="email" />
  </div>
</div>

              <div class="row" style="margin-top:10px;">
                <div class="col">
                  <label>Edad *</label>
                  <input id="age" type="number" min="0" />
                </div>

                <div class="col">
                  <label>GÃ©nero *</label>
                  <select id="gender" class="select">
                    <option value="">-- Seleccionar --</option>
                    <option value="Masculino">Masculino</option>
                    <option value="Femenino">Femenino</option>
                  </select>
                </div>

                <div class="col">
                  <label>Cargo en la iglesia</label>
                  <input id="church_role" />
                </div>
              </div>

              <div class="row" style="margin-top:10px;">
                <div class="col">
                  <label>Nombre del padre</label>
                  <input id="father_name" />
                </div>
                <div class="col">
                  <label>Nombre de la madre</label>
                  <input id="mother_name" />
                </div>
                <div class="col">
                  <label>Nombre de la congregaciÃ³n</label>
                  <input id="congregation_name"/>
                </div>
              </div>

              <!-- âœ… NUEVO: Celulares y cumpleaÃ±os de papÃ¡s -->
<div class="row" style="margin-top:10px;">
  <div class="col">
    <label>Celular del padre</label>
    <input id="father_phone" placeholder="Ej: 3001234567" inputmode="tel" />
  </div>
  <div class="col">
    <label>Celular de la madre</label>
    <input id="mother_phone" placeholder="Ej: 3001234567" inputmode="tel" />
  </div>
  <div class="col">
    <label>CumpleaÃ±os del padre</label>
    <input id="father_birth_date" type="date" />
  </div>
</div>

<div class="row" style="margin-top:10px;">
  <div class="col">
    <label>CumpleaÃ±os de la madre</label>
    <input id="mother_birth_date" type="date" />
  </div>
</div>
            </div>
          </div>

          <hr class="sep" />

          <div class="row">
            <div class="col">
              <label>Tiempo de conversiÃ³n</label>
              <input id="conversion_time" placeholder="Ej: 2 aÃ±os / 6 meses" />
            </div>
            <div class="col">
              <label>Lugar bautismo/acto</label>
              <input id="event_place"/>
            </div>
          </div>

          <div class="row" style="margin-top:10px;">
            <div class="col">
              <label>Fecha del bautismo</label>
              <input id="baptism_date" type="date" />
            </div>
            <div class="col">
              <label>Fecha recepciÃ³n EspÃ­ritu Santo</label>
              <input id="holy_spirit_date" type="date" />
            </div>
            <div class="col">
              <label>Pastor oficiante</label>
              <input id="officiant_pastor" />
            </div>
          </div>

          <div class="row" style="margin-top:10px;">
            <div class="col">
              <label>Fecha membresÃ­a en la congregaciÃ³n</label>
              <input id="membership_date" type="date" />
            </div>
            <div class="col">
              <label>Tiempo de membresÃ­a</label>
              <input id="membership_time" placeholder="Ej: 1 aÃ±o / 4 meses" />
            </div>
            <div class="col">
              <label>Lugar de procedencia</label>
              <input id="origin_place" />
            </div>
          </div>

          <div class="row" style="margin-top:10px;align-items:center;">
            <div class="col">
              <label>Â¿Menos de 6 meses en la congregaciÃ³n?</label>
              <input id="less_than_6_months" type="checkbox" />
              <div class="hint">Activa si el miembro lleva menos de 6 meses.</div>
            </div>

            <div class="col">
              <label>Simpatizante</label>
              <input id="is_sympathizer" type="checkbox" />
              <div class="hint">Activa si la persona es simpatizante.</div>
            </div>

            <div class="col">
              <div class="hint muted"></div>
            </div>
          </div>

          <div style="margin-top:10px;">
            <label>Observaciones</label>
            <textarea id="observations" placeholder="Notas adicionales..."></textarea>
          </div>

          <div style="display:flex;gap:10px;justify-content:flex-end;flex-wrap:wrap;margin-top:14px;">
            <button class="btn primary" id="btnInviteSubmit">Enviar</button>
          </div>

          <div class="hint" style="margin-top:10px;">
            * Este formulario usa un link de invitaciÃ³n.
          </div>
        </div>

      </div>
    </div>
  `);

  // âœ… MEJOR OPCIÃ“N: acepta "btnX" o "#btnX"
  const $ = (id) => {
    const clean = String(id).startsWith("#") ? String(id).slice(1) : String(id);
    return node.querySelector("#" + clean);
  };



  // IdentificaciÃ³n: solo nÃºmeros (igual que la app)
  const idInput = $("#identification");
  if (idInput){
    const onlyDigits = () => {
      const v = idInput.value || "";
      const cleaned = v.replace(/\D+/g, "");
      if (v !== cleaned) idInput.value = cleaned;
    };
    idInput.addEventListener("input", onlyDigits);
    idInput.addEventListener("paste", () => setTimeout(onlyDigits, 0));
  }

  // Foto (igual que la app)
  function renderPhoto(url){
    const box = $("#photoBox");
    box.innerHTML = "";
    if (!url){
      box.appendChild(el(`<div class="small">Sin foto</div>`));
      return;
    }
    const img = document.createElement("img");
    img.src = url;
    img.alt = "Foto miembro";
    box.appendChild(img);
  }

function renderGuardianPhoto(url){
  const box = $("#guardianPhotoBox");
  if (!box) return;

  box.innerHTML = "";
  if (!url){
    box.appendChild(el(`<div class="small">Sin foto</div>`));
    return;
  }

  const img = document.createElement("img");
  img.src = url;
  img.alt = "Foto acudiente";
  box.appendChild(img);
}

  function handlePickedPhoto(file){
    draft.photo_file = file;

    if (!file){
      draft.photo_preview_url = "";
      renderPhoto("");
      $("#photoInfo").textContent = "Se mostrarÃ¡ aquÃ­ como vista previa.";
      return;
    }
    const url = URL.createObjectURL(file);
    draft.photo_preview_url = url;
    renderPhoto(url);
    $("#photoInfo").textContent = `${file.name} Â· vista previa lista`;
  }

  $("#photoInput").addEventListener("change", ()=>{
    const file = $("#photoInput").files?.[0] || null;
    handlePickedPhoto(file);
  });

  $("#photoInputCamera").addEventListener("change", ()=>{
    const file = $("#photoInputCamera").files?.[0] || null;
    handlePickedPhoto(file);
  });

  $("#btnPickPhoto").addEventListener("click", ()=> $("#photoInput").click());
  $("#btnTakePhoto").addEventListener("click", ()=> $("#photoInputCamera").click());

  // âœ… Foto del acudiente (igual que la app)
function handlePickedGuardianPhoto(file){
  draft.guardian_photo_file = file;

  if (!file){
    draft.guardian_photo_preview_url = "";
    renderGuardianPhoto("");
    $("#guardianPhotoInfo").textContent = "Se mostrarÃ¡ aquÃ­ como vista previa.";
    return;
  }

  const url = URL.createObjectURL(file);
  draft.guardian_photo_preview_url = url;
  renderGuardianPhoto(url);

  $("#guardianPhotoInfo").textContent = `${file.name} Â· vista previa lista`;
}

$("#guardianPhotoInput")?.addEventListener("change", ()=>{
  const file = $("#guardianPhotoInput").files?.[0] || null;
  handlePickedGuardianPhoto(file);
});

$("#guardianPhotoInputCamera")?.addEventListener("change", ()=>{
  const file = $("#guardianPhotoInputCamera").files?.[0] || null;
  handlePickedGuardianPhoto(file);
});

$("#btnPickGuardianPhoto")?.addEventListener("click", ()=> $("#guardianPhotoInput")?.click());
$("#btnTakeGuardianPhoto")?.addEventListener("click", ()=> $("#guardianPhotoInputCamera")?.click());



  // Leer formulario (mismo mapping que tu saveMember)
  function readPublicForm(){
    draft.first_names = $("#first_names").value.trim();
    draft.last_names = $("#last_names").value.trim();
    draft.identification = $("#identification").value.trim();
    draft.address = $("#address").value.trim();
    draft.city = $("#city").value.trim();
    draft.phone = ($("#phone")?.value || "").trim();
    draft.email = ($("#email")?.value || "").trim();
    draft.birth_date = $("#birth_date").value || "";
    draft.father_name = $("#father_name").value.trim();
    draft.mother_name = $("#mother_name").value.trim();
    draft.father_phone = ($("#father_phone")?.value || "").trim();
    draft.mother_phone = ($("#mother_phone")?.value || "").trim();
    draft.father_birth_date = $("#father_birth_date")?.value || "";
    draft.mother_birth_date = $("#mother_birth_date")?.value || "";
    draft.congregation_name = $("#congregation_name").value.trim();
    draft.conversion_time = $("#conversion_time").value.trim();
    draft.baptism_date = $("#baptism_date").value || "";
    draft.holy_spirit_date = $("#holy_spirit_date").value || "";
    draft.event_place = $("#event_place").value.trim();
    draft.officiant_pastor = $("#officiant_pastor").value.trim();
    draft.membership_date = $("#membership_date").value || "";
    draft.membership_time = $("#membership_time").value.trim();
    draft.origin_place = $("#origin_place").value.trim();
    draft.less_than_6_months = $("#less_than_6_months").checked;
    draft.is_sympathizer = $("#is_sympathizer").checked;
    draft.observations = $("#observations").value.trim();

    const ageRaw = ($("#age").value || "").trim();
    draft.age = ageRaw === "" ? null : Number(ageRaw);

    draft.church_role = $("#church_role").value.trim();
    draft.gender = $("#gender").value || "";

    return draft;
  }

  // Enviar
  $("#btnInviteSubmit").addEventListener("click", async ()=>{
    try{
      showLoader("Enviandoâ€¦", "Guardando en la base de datos");

      const m = readPublicForm();

      // Validaciones iguales
      if (!m.first_names || !m.last_names || !m.identification){
        toast("Nombres, apellidos e identificaciÃ³n son obligatorios.", "info");
        return;
      }
      const ageNum = Number(m.age);
      if (m.age === null || !Number.isFinite(ageNum) || ageNum < 0){
        toast("La edad es obligatoria y debe ser un nÃºmero vÃ¡lido (>= 0).", "info");
        return;
      }
      if (!m.gender){
        toast("El gÃ©nero es obligatorio. Selecciona Masculino o Femenino.", "info");
        return;
      }

      // âœ… Subir foto igual que la app (si envÃ­an foto)
      const prefix = (m.identification || "unknown").trim() || "unknown";
      let photo = { path: null, url: null };
      if (m.photo_file){
        photo = await uploadFile("member-photos", m.photo_file, prefix);
      }


      let guardianPhoto = { path: null, url: null };
if (m.guardian_photo_file){
  guardianPhoto = await uploadFile("member-photos", m.guardian_photo_file, `guardian_${prefix}`);
}
      // Payload COMPLETO (mismo que saveMember)
      const payload = {
        first_names: m.first_names,
        last_names: m.last_names,
        identification: m.identification,
        age: m.age ?? null,
        gender: m.gender || null,
        church_role: m.church_role || null,
        address: m.address || null,
        city: m.city || null,
        phone: m.phone || null,
        email: m.email || null,
father_phone: m.father_phone || null,
mother_phone: m.mother_phone || null,
father_birth_date: m.father_birth_date || null,
mother_birth_date: m.mother_birth_date || null,
guardian_photo_path: guardianPhoto.path,
guardian_photo_url: guardianPhoto.url,
        birth_date: m.birth_date || null,
        father_name: m.father_name || null,
        mother_name: m.mother_name || null,
        congregation_name: m.congregation_name || null,
        conversion_time: m.conversion_time || null,
        baptism_date: m.baptism_date || null,
        holy_spirit_date: m.holy_spirit_date || null,
        event_place: m.event_place || null,
        officiant_pastor: m.officiant_pastor || null,
        membership_date: m.membership_date || null,
        membership_time: m.membership_time || null,
        origin_place: m.origin_place || null,
        less_than_6_months: !!m.less_than_6_months,
        is_sympathizer: !!m.is_sympathizer,
        observations: m.observations || null,
        photo_path: photo.path,
        photo_url: photo.url,
      };

      // âœ… Endpoint correcto
    const res = await fetch(`${SUPABASE_URL}/functions/v1/submit-member-invit`, {
  method: "POST",
  headers: {
    "Content-Type": "application/json",
    "apikey": SUPABASE_ANON_KEY,
    "Authorization": `Bearer ${SUPABASE_ANON_KEY}`,
  },
  body: JSON.stringify({ inviteToken, payload })
});

      const data = await res.json().catch(()=> ({}));
      if (!res.ok) throw new Error(data?.error || data?.message || `HTTP ${res.status}`);

      toast("âœ… Enviado correctamente. Â¡Gracias!", "success");
      clearInviteFromUrl();
      render();

    } catch(e){
      console.error(e);
      toast("âŒ Error enviando: " + (e?.message || e), "error");
    } finally {
      hideLoader();
    }
  });

  return node;
}





function render(){
  app.innerHTML = "";

  const invite = getInviteTokenFromUrl();

  // âœ… Si es link pÃºblico: SOLO formulario, sin header/login
  if (invite){
    // por si algo usa sticky/offset
    document.documentElement.style.setProperty("--header-offset", "0px");

    try{
      const form = viewInviteForm(invite);
      app.appendChild(form);
    } catch(e){
      console.error("Error render invite form:", e);

      // fallback visible (para que no quede solo el fondo)
      const box = document.createElement("div");
      box.className = "container";
      box.innerHTML = `
        <div class="card">
          <h3 style="margin:0 0 10px;">âŒ Error cargando formulario</h3>
          <div class="small muted">Mira la consola (F12) para mÃ¡s detalle.</div>
          <hr class="sep"/>
          <pre style="white-space:pre-wrap;word-break:break-word;max-width:100%;">${String(e?.message || e)}</pre>
        </div>
      `;
      app.appendChild(box);
    }
    return;
  }

  // âœ… Normal (app): header + mÃ³dulos
  const header = renderHeader();
  app.appendChild(header);

  const h = Math.ceil(header.getBoundingClientRect().height);
  document.documentElement.style.setProperty("--header-offset", (h + 8) + "px");

  app.appendChild(viewMiembros());
}



let __resumeLock = false;
let __lastResumeAt = 0;

async function handleAppResume(){
  const now = Date.now();
  if (__resumeLock) return;
  if (now - __lastResumeAt < 1200) return; // anti-spam
  __lastResumeAt = now;

  __resumeLock = true;
  try{
    // âœ… Reactiva el auto refresh si el navegador lo pausÃ³
    try { supabase.auth.startAutoRefresh?.(); } catch {}

    // âœ… Marca "verificando" y repinta UNA vez (para que no quede pegado)
    state.auth.ready = false;
    render();

    // âœ… Revalida sesiÃ³n real + allowed_emails (con tu requireAuth con retry)
    await requireAuth({ silent: true });

    // âœ… Render final estable
    render();
  } finally {
    __resumeLock = false;
  }
}



    
  // ===== Boot: local email auth (sin Google) =====
bootstrapLocalAuth();

// âœ… CumpleaÃ±os Modal: botÃ³n "Enviar a este telÃ©fono"
document.getElementById("btnCumplePwaPushSelf")?.addEventListener("click", async () => {
  try{
    const ok = await requireAuth();
    if (!ok) return;

    const reg = await navigator.serviceWorker.ready;
    const subscription = await reg.pushManager.getSubscription();
    if (!subscription){
      toast("Primero activa ðŸ”” Notificaciones para este dispositivo.", "info");
      return;
    }

    const res = await fetch(`${SUPABASE_URL}/functions/v1/send-birthday-push-self`, {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
        "apikey": SUPABASE_ANON_KEY
      },
      body: JSON.stringify({ email: state.auth.email, subscription })
    });

    const data = await res.json().catch(()=> ({}));
    if (res.ok) toast("âœ… Enviado a este telÃ©fono.", "success");
    else toast("âŒ Error: " + (data?.error || data?.message || res.status), "error");
  } catch(e){
    console.error(e);
    toast("âŒ Error enviando: " + (e?.message || e), "error");
  }
});



// ===== CumpleaÃ±os modal handlers =====
document.getElementById("btnCumplePwaClose")?.addEventListener("click", closeCumplePwaModal);

document.getElementById("cumplePwaContenedor")?.addEventListener("click", (e) => {
  if (e.target === document.getElementById("cumplePwaContenedor")) closeCumplePwaModal();
});

document.getElementById("cumplePwaMesSelect")?.addEventListener("change", (e) => {
  const v = Number(e.target.value);
  cargarCumplePwaMes(v);
});


  </script>
</body>
</html>
